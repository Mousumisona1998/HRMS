{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .page-header {
    /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
    color: black;
    padding: 1rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    /* box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); */
  }

  .page-header h1 {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .custom-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .custom-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
  }

  .card-header {
    /* background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); */
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
  }

  .card-title {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
  }

  .form-control, .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: #718096;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-secondary:hover {
    background: #4a5568;
    transform: translateY(-2px);
  }

  .balance-item {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border: none !important;
    border-radius: 12px;
    transition: transform 0.3s ease;
  }

  .balance-item:hover {
    transform: scale(1.02);
  }

  .badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
  }

  #balance-display {
    /* background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); */
    background: cornsilk;
    border: none;
    font-weight: 600;
  }

  #days-display {
    /* background: linear-gradient(135deg, #fdeb71 0%, #f8d800 100%); */
    border: none;
    font-weight: 600;
    color: #2d3748;
  }

  .half-day-section {
    background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .half-day-toggle {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .toggle-switch {
    position: relative;
    width: 60px;
    height: 30px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 30px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .toggle-slider {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  input:checked + .toggle-slider:before {
    transform: translateX(30px);
  }

  .half-options {
    display: none;
    margin-top: 1rem;
  }

  .half-options.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .half-option-btn {
    flex: 1;
    padding: 1rem;
    border: 3px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
  }

  .half-option-btn:hover {
    border-color: #667eea;
    transform: scale(1.05);
  }

  .half-option-btn.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
  }

  .half-option-btn input[type="radio"] {
    display: none;
  }

  .tips-list li {
    padding: 0.75rem;
    background: #f7fafc;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
  }

  .tips-list li:hover {
    background: #edf2f7;
    transform: translateX(5px);
  }

  .icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    margin-right: 0.5rem;
  }

  /* NEW: Probation Alert Styles */
  .probation-alert {
    /* background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); */
    color: #dc3545;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    border-left: 5px solid #c23616;
  }

  .probation-alert i {
    font-size: 1.2rem;
    margin-right: 0.5rem;
  }

  .rule-info {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
  }

  .rule-item {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0 8px 8px 0;
  }

  .leave-type-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
    /* NEW: Advance Notice Warning Styles */
  .advance-notice-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    color: #856404;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    display: none;
  }

  .advance-notice-warning.show {
    display: block;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .warning-icon {
    color: #ffc107;
    font-size: 1.2rem;
    margin-right: 0.5rem;
  }
</style>

<div class="container-fluid">
  <div class="page-header">
    <h1>
      <span class="icon-wrapper">
        <i class="fas fa-calendar-plus"></i>
      </span>
      Apply for Leave
    </h1>
    <p class="mb-0">Submit your leave application with ease</p>
  </div>

  <!-- NEW: Probation Alert -->
  {% if is_on_probation %}
  <div class="probation-alert">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <h5 class="mb-1">You are currently on probation</h5>
        <p class="mb-0">{{ probation_message }}</p>
        {% if employee.probation_end_date %}
        <small>Probation ends on: {{ employee.probation_end_date }}</small>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- NEW: Advance Notice Warning (Dynamic) -->
  <div class="advance-notice-warning" id="advance_notice_warning">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <div>
        <h5 class="mb-1" id="warning_title">Advance Notice Required</h5>
        <p class="mb-0" id="warning_message"></p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-file-alt"></i> Leave Application Form
          </h5>
        </div>

        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="leave_type" class="form-label">
                <i class="fas fa-list-alt"></i> Leave Type *
              </label>
              <select
                class="form-select"
                id="leave_type"
                name="leave_type"
                required
                {% if is_on_probation %}onchange="checkProbationLeaveType(this)"{% endif %}
              >
                <option value="">Select Leave Type</option>
                {% for leave_type in leave_types %}
                <option value="{{ leave_type.id }}" 
                        data-name="{{ leave_type.name }}"
                        {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}disabled{% endif %}>
                  {{ leave_type.name }}
                  {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}
                  -  Not allowed during probation
                  {% endif %}
                </option>
                {% endfor %}
              </select>
              <div class="leave-type-info" id="leave_type_info"></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-wallet"></i> Available Balance
              </label>
              <div id="balance-display" class="form-control">
                Select a leave type to see balance
              </div>
            </div>
          </div>

          <!-- Half Day Section -->
          <div class="half-day-section">
            <div class="half-day-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="half_day_toggle">
                <span class="toggle-slider"></span>
              </label>
              <label for="half_day_toggle" style="cursor: pointer; font-weight: 600; color: #2d3748;">
                <i class="fas fa-clock"></i> Half Day Leave
              </label>
            </div>
            
            <div class="half-options" id="half_options">
              <label class="form-label mb-2">
                <i class="fas fa-sun"></i> Select Half
              </label>
              <div class="d-flex gap-3">
                <label class="half-option-btn" for="first_half" id="first_half_label">
                  <input type="radio" name="half_day_period" value="first_half" id="first_half">
                  <i class="fas fa-cloud-sun"></i>
                  <div>First Half</div>
                  <small class="text-muted">Morning Session</small>
                </label>
                <label class="half-option-btn" for="second_half" id="second_half_label">
                  <input type="radio" name="half_day_period" value="second_half" id="second_half">
                  <i class="fas fa-moon"></i>
                  <div>Second Half</div>
                  <small class="text-muted">Evening Session</small>
                </label>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="start_date" class="form-label">
                <i class="fas fa-calendar-day"></i> Start Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="start_date"
                name="start_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="end_date" class="form-label">
                <i class="fas fa-calendar-check"></i> End Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="end_date"
                name="end_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-calendar-alt"></i> Total Working Days
              </label>
              <div id="days-display" class="form-control">0 days</div>
              <small class="text-muted">Excludes weekends and holidays</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="attachment" class="form-label">
                <i class="fas fa-paperclip"></i> Attachment (Optional)
              </label>
              <input
                type="file"
                class="form-control"
                id="attachment"
                name="attachment"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              />
              <small class="text-muted">
                Max 5MB. Required for sick leave with medical certificate
              </small>
            </div>
          </div>

          <div class="mb-3">
            <label for="reason" class="form-label">
              <i class="fas fa-comment-dots"></i> Reason for Leave *
            </label>
            <textarea
              class="form-control"
              id="reason"
              name="reason"
              rows="4"
              placeholder="Please provide a detailed reason for your leave application..."
              required
            ></textarea>
          </div>

          <!-- Hidden fields for backend -->
          <input type="hidden" name="total_days" id="total_days" value="0">
          <input type="hidden" name="is_half_day" id="is_half_day" value="false">

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="submit_btn">
              <i class="fas fa-paper-plane"></i> Submit Application
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="history.back()"
            >
              <i class="fas fa-arrow-left"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-md-4">
      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </h5>
        </div>
        <div class="leave-balance-list">
          {% for balance in leave_balances %}
          <div class="balance-item mb-3 p-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold">{{ balance.leave_type.name }}</span>
              <span class="badge bg-primary">{{ balance.leaves_remaining }} days</span>
            </div>
            <small class="text-muted">
              Total: {{ balance.total_leaves|floatformat:1 }} days | Taken: {{ balance.leaves_taken|floatformat:1 }} days
              {% if balance.leave_type.name == 'Optional' %}
              <br><strong>Max usable: 2 days</strong>
              {% endif %}
              {% if balance.leave_type.name == 'Earned' %}
              <br>Monthly: 1.5 days
              {% endif %}
            </small>
          </div>
          {% empty %}
          <div class="text-center text-muted py-3">
            <i class="fas fa-info-circle fa-2x mb-2"></i>
            <p>No leave balance found</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-lightbulb"></i> Quick Tips
          </h5>
        </div>
        <ul class="list-unstyled tips-list">
          <li>
            <i class="fas fa-check text-success"></i> Apply at least 3 days in advance
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Check your leave balance before applying
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Attach medical certificate for sick leave
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Contact your manager for urgent leaves
          </li>
          {% if is_on_probation %}
          <li>
            <i class="fas fa-exclamation-triangle text-warning"></i> Probation restrictions apply
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('leave_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const balanceDisplay = document.getElementById('balance-display');
    const daysDisplay = document.getElementById('days-display');
    const halfDayToggle = document.getElementById('half_day_toggle');
    const halfOptions = document.getElementById('half_options');
    const firstHalfLabel = document.getElementById('first_half_label');
    const secondHalfLabel = document.getElementById('second_half_label');
    const firstHalfRadio = document.getElementById('first_half');
    const secondHalfRadio = document.getElementById('second_half');
    const leaveTypeInfo = document.getElementById('leave_type_info');
    const submitBtn = document.getElementById('submit_btn');
    const advanceNoticeWarning = document.getElementById('advance_notice_warning');
    const warningTitle = document.getElementById('warning_title');
    const warningMessage = document.getElementById('warning_message');
    const leaveForm = document.getElementById('leave_form');

    const leaveBalances = {
        {% for balance in leave_balances %}
        '{{ balance.leave_type.id }}': {
            'remaining': {{ balance.leaves_remaining }},
            'taken': {{ balance.leaves_taken }},
            'total': {{ balance.total_leaves }},
            'name': '{{ balance.leave_type.name }}',
            'is_optional': {% if balance.leave_type.is_optional %}true{% else %}false{% endif %},
            'max_carry_forward': {{ balance.leave_type.max_carry_forward }},
            'can_use_same_month': {% if balance.leave_type.can_use_same_month %}true{% else %}false{% endif %}
        },
        {% endfor %}
    };

    // // Initialize Flatpickr with DD-MM-YYYY format
    // const startPicker = flatpickr(startDateInput, {
    //     dateFormat: "d-m-Y",
    //     minDate: "today",
    //     onChange: function(selectedDates, dateStr, instance) {
    //         console.log("Start date selected:", dateStr);
    //         if (halfDayToggle.checked) {
    //             endDateInput.value = dateStr;
    //             endPicker.setDate(dateStr);
    //         }
    //         calculateDays();
    //         checkSameMonthAccrual();
    //     }
    // });

    // const endPicker = flatpickr(endDateInput, {
    //     dateFormat: "d-m-Y",
    //     minDate: "today",
    //     onChange: function(selectedDates, dateStr, instance) {
    //         console.log("End date selected:", dateStr);
    //         calculateDays();
    //     }
    // });



     // Initialize Bootstrap Datepicker with DD-MM-YYYY format
    $(startDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("Start date selected:", e.format());
        if (halfDayToggle.checked) {
            // Set end date to same as start date
        const selectedDate = e.format(); // This gives DD-MM-YYYY format
        endDateInput.value = selectedDate;
        $(endDateInput).datepicker('setDate', e.date);
        $(endDateInput).datepicker('update'); // Force update
        }
        calculateDays();
        checkSameMonthAccrual();
        checkAdvanceNotice(); // NEW: Check advance notice
    });

    $(endDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("End date selected:", e.format());
        calculateDays();
        checkAdvanceNotice(); // NEW: Check advance notice
    });

    // Helper function to get formatted date from datepicker
    function getFormattedDate(date) {
        if (!date) return '';
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }



    

    // Parse DD-MM-YYYY format to Date object
    function parseDate(dateStr) {
        if (!dateStr || dateStr.trim() === '') return null;
        
        // Handle DD-MM-YYYY format
        const parts = dateStr.trim().split('-');
        if (parts.length !== 3) {
            console.error("Invalid date format:", dateStr);
            return null;
        }
        
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
        const year = parseInt(parts[2], 10);
        
        if (isNaN(day) || isNaN(month) || isNaN(year)) {
            console.error("Invalid date parts:", {day, month, year});
            return null;
        }
        
        const date = new Date(year, month, day);
        
        // Validate the date
        if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
            console.error("Invalid date created:", date);
            return null;
        }
        
        return date;
    }
     // NEW: Check advance notice requirements using WORKING DAYS
function checkAdvanceNotice() {
    const startDateStr = startDateInput.value;
    const endDateStr = endDateInput.value;
    const isHalfDay = halfDayToggle.checked;

    // Reset warning
    advanceNoticeWarning.classList.remove('show');
    
    if (!startDateStr || !endDateStr || isHalfDay) {
        return;
    }

    const startDate = parseDate(startDateStr);
    const endDate = parseDate(endDateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (!startDate || !endDate) return;

    // Calculate working days until start (excluding weekends)
    const daysUntilStart = calculateWorkingDaysBetween(today, startDate);
    
    // Get working days duration from the same logic as calculateDays()
    const workingDaysDuration = calculateWorkingDaysBetween(startDate, endDate);

    console.log(`Advance Notice Check: ${workingDaysDuration} working days leave starting in ${daysUntilStart} working days`);

    // Check advance notice rules based on working days
    if (workingDaysDuration >= 3 && workingDaysDuration < 7 && daysUntilStart < 7) {
        showAdvanceNoticeWarning(
            '7-Day Advance Notice Required',
            `You are applying for ${workingDaysDuration} working days. For leaves of 3 days or more, please apply at least 7 working days in advance.`
        );
    } else if (workingDaysDuration >= 7 && daysUntilStart < 15) {
        showAdvanceNoticeWarning(
            '15-Day Advance Notice Required',
            `You are applying for ${workingDaysDuration} working days leave starting in ${daysUntilStart} working days. For leaves longer than 7 days, please apply at least 15 working days in advance.`
        );
    }
}

// Helper function to calculate working days between two dates
function calculateWorkingDaysBetween(startDate, endDate) {
    let workingDays = 0;
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        // 0 = Sunday, 6 = Saturday
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            workingDays++;
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return workingDays;
}
    // NEW: Show advance notice warning
    function showAdvanceNoticeWarning(title, message) {
        warningTitle.textContent = title;
        warningMessage.textContent = message;
        advanceNoticeWarning.classList.add('show');
        
        // Scroll to warning for visibility
        advanceNoticeWarning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Calculate working days
    function calculateDays() {
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;

        console.log('=== Calculate Days Debug ===');
        console.log('Start date string:', startDateStr);
        console.log('End date string:', endDateStr);
        console.log('Is half day:', halfDayToggle.checked);

        if (!startDateStr || !endDateStr) {
            console.log('Missing date(s)');
            daysDisplay.textContent = '0 days';
            document.getElementById('total_days').value = '0';
            document.getElementById('is_half_day').value = 'false';
            return;
        }

        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        console.log('Parsed start date:', startDate);
        console.log('Parsed end date:', endDate);

        if (!startDate || !endDate) {
            console.error('Failed to parse dates');
            daysDisplay.textContent = 'Invalid date format';
            document.getElementById('total_days').value = '0';
            document.getElementById('is_half_day').value = 'false';
            return;
        }

        if (endDate < startDate) {
            console.log('End date before start date');
            daysDisplay.textContent = 'Invalid date range';
            document.getElementById('total_days').value = '0';
            document.getElementById('is_half_day').value = 'false';
            return;
        }

        // CHECK HALF DAY FIRST!
        console.log('Checking half day status...');
        console.log('halfDayToggle.checked =', halfDayToggle.checked);

        if (halfDayToggle.checked === true) {
            console.log('✓ Half day mode ACTIVE - setting 0.5 days');
            daysDisplay.innerHTML = '<span class="fw-bold text-primary">0.5 days</span> <small class="text-info">(Half Day)</small>';
            document.getElementById('total_days').value = '0.5';
            document.getElementById('is_half_day').value = 'true';
            console.log('Set total_days input to:', document.getElementById('total_days').value);
            console.log('Set is_half_day input to:', document.getElementById('is_half_day').value);
            return;
        }
        // Calculate working days (excluding weekends)
        let workingDays = 0;
        let currentDate = new Date(startDate);

        console.log('Calculating working days...');
        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay();
            console.log(`Date: ${currentDate.toDateString()}, Day: ${dayOfWeek}`);
            
            // 0 = Sunday, 6 = Saturday
            if (dayOfWeek !== 0) {
                workingDays++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }

        console.log('Total working days:', workingDays);
        
        daysDisplay.innerHTML = `<span class="fw-bold">${workingDays} ${workingDays === 1 ? 'day' : 'days'}</span>`;
        document.getElementById('total_days').value = workingDays.toString();
        document.getElementById('is_half_day').value = 'false';
    }

    // Check same month accrual restriction
    function checkSameMonthAccrual() {
        const selectedType = leaveTypeSelect.value;
        if (!selectedType || !leaveBalances[selectedType]) return;

        const leaveType = leaveBalances[selectedType];
        const startDateStr = startDateInput.value;
        
        if (!startDateStr) return;
        
        const startDate = parseDate(startDateStr);
        if (!startDate) return;
        
        const currentDate = new Date();
        
        if (!leaveType.can_use_same_month && 
            startDate.getMonth() === currentDate.getMonth() && 
            startDate.getFullYear() === currentDate.getFullYear()) {
            leaveTypeInfo.innerHTML = '<span class="text-warning">⚠️ This leave type cannot be used in the same month it is accrued</span>';
        } else {
            if (!leaveType.is_optional) {
                leaveTypeInfo.innerHTML = '';
            }
        }
    }

    // Update balance display when leave type changes
    leaveTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        if (selectedType && leaveBalances[selectedType]) {
            const balance = leaveBalances[selectedType];
            let infoHtml = '';
            
            if (balance.is_optional) {
                const remainingUsable = Math.max(0, 2 - balance.taken);
                infoHtml = `<span class="text-info">Max usable: ${remainingUsable} days remaining</span>`;
            }
            
            if (!balance.can_use_same_month) {
                infoHtml += `<br><span class="text-warning">Cannot use in same month as accrual</span>`;
            }
            
            balanceDisplay.innerHTML = `
                <span class="text-success fw-bold">${balance.remaining} days available</span>
                <small class="d-block text-muted">(Total: ${balance.total}, Taken: ${balance.taken})</small>
                ${infoHtml}
            `;
            
            leaveTypeInfo.innerHTML = infoHtml;
        } else {
            balanceDisplay.textContent = 'Select a leave type to see balance';
            leaveTypeInfo.innerHTML = '';
        }
        
        checkSameMonthAccrual();
    });

    // Half day toggle functionality
halfDayToggle.addEventListener('change', function() {
    console.log('Half-day toggle changed:', this.checked);
    
    if (this.checked) {
        halfOptions.classList.add('active');
        
        // If start date is already selected, copy it to end date
        if (startDateInput.value && startDateInput.value !== 'DD-MM-YYYY') {
            console.log('Copying start date to end date:', startDateInput.value);
            endDateInput.value = startDateInput.value;
            
            // Parse the date and set it in datepicker
            const startDate = parseDate(startDateInput.value);
            if (startDate) {
                $(endDateInput).datepicker('setDate', startDate);
                $(endDateInput).datepicker('update');
            }
        }
        
        // Disable end date field for half-day
        endDateInput.disabled = true;
        endDateInput.readOnly = true;
        $(endDateInput).datepicker('disable');
        
        calculateDays(); // This should set 0.5 days
    } else {
        halfOptions.classList.remove('active');
        firstHalfRadio.checked = false;
        secondHalfRadio.checked = false;
        firstHalfLabel.classList.remove('selected');
        secondHalfLabel.classList.remove('selected');
        
        // Re-enable end date field
        endDateInput.disabled = false;
        endDateInput.readOnly = false;
        $(endDateInput).datepicker('enable');
        
        calculateDays();
    }
});
    // Half day option selection - Listen to radio button changes
    firstHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            firstHalfLabel.classList.add('selected');
            secondHalfLabel.classList.remove('selected');
            console.log('First half selected');
        }
    });

    secondHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            secondHalfLabel.classList.add('selected');
            firstHalfLabel.classList.remove('selected');
            console.log('Second half selected');
        }
    });

    // Manual input handlers (in case user types the date)
    startDateInput.addEventListener('input', function() {
        console.log("Start date input:", this.value);
        if (halfDayToggle.checked) {
            endDateInput.value = this.value;
        }
        calculateDays();
        checkSameMonthAccrual();
    });

    endDateInput.addEventListener('input', function() {
        console.log("End date input:", this.value);
        calculateDays();
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const totalDays = document.getElementById('total_days').value;
        const isHalfDay = document.getElementById('is_half_day').value;
        
        console.log("Form submit - total_days:", totalDays);
        console.log("Form submit - is_half_day:", isHalfDay);
        console.log("Form submit - first_half checked:", firstHalfRadio.checked);
        console.log("Form submit - second_half checked:", secondHalfRadio.checked);
        
        // Validate half-day period selection
        if (halfDayToggle.checked) {
            if (!firstHalfRadio.checked && !secondHalfRadio.checked) {
                e.preventDefault();
                alert('Please select either First Half or Second Half for half-day leave.');
                return false;
            }
            if (parseFloat(totalDays) <= 0) {
                e.preventDefault();
                alert('Please select valid dates. Total working days cannot be 0.');
                return false;
            }
        }    
    });
});
</script>
{% endblock %}