{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .page-header {
    /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
    color: black;
    padding: 1rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    /* box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); */
  }

  .page-header h1 {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .custom-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .custom-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
  }

  .card-header {
    /* background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); */
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
  }

  .card-title {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
  }

  .form-control, .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: #718096;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-secondary:hover {
    background: #4a5568;
    transform: translateY(-2px);
  }

  .balance-item {
    background: linear-gradient(135deg, #ffecd2 0%, #fdfaf9 100%);
    border: none !important;
    border-radius: 12px;
    transition: transform 0.3s ease;
  }

  .balance-item:hover {
    transform: scale(1.02);
  }

  .badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
  }

  #balance-display {
    /* background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); */
    background: cornsilk;
    border: none;
    font-weight: 600;
  }

  #days-display {
    /* background: linear-gradient(135deg, #fdeb71 0%, #f8d800 100%); */
    border: none;
    font-weight: 600;
    color: #2d3748;
  }

  .half-day-section {
    background: linear-gradient(135deg, #8e9bd9 0%, #8ec5fc 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .half-day-toggle {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .toggle-switch {
    position: relative;
    width: 60px;
    height: 30px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 30px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .toggle-slider {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  input:checked + .toggle-slider:before {
    transform: translateX(30px);
  }

  .half-options {
    display: none;
    margin-top: 1rem;
  }

  .half-options.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .half-option-btn {
    flex: 1;
    padding: 1rem;
    border: 3px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
  }

  .half-option-btn:hover {
    border-color: #667eea;
    transform: scale(1.05);
  }

  .half-option-btn.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
  }

  .half-option-btn input[type="radio"] {
    display: none;
  }

  .tips-list li {
    padding: 0.75rem;
    background: #f7fafc;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
  }

  .tips-list li:hover {
    background: #edf2f7;
    transform: translateX(5px);
  }

  .icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    margin-right: 0.5rem;
  }

  /* NEW: Probation Alert Styles */
  .probation-alert {
    /* background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); */
    color: #dc3545;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    border-left: 5px solid #c23616;
  }

  .probation-alert i {
    font-size: 1.2rem;
    margin-right: 0.5rem;
  }

  .rule-info {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
  }

  .rule-item {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0 8px 8px 0;
  }

  .leave-type-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
    /* NEW: Advance Notice Warning Styles */
  .advance-notice-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    color: #856404;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    display: none;
  }

  .advance-notice-warning.show {
    display: block;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .warning-icon {
    color: #ffc107;
    font-size: 1.2rem;
    margin-right: 0.5rem;
  }
  /* Add this to your existing CSS section */
.optional-holidays-section {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 1px solid #c3e6cb;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: none;
}

.optional-holidays-section.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.optional-holiday-item {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.optional-holiday-item:hover {
    border-color: #28a745;
    transform: translateX(5px);
}

.optional-holiday-item.selected {
    background: #d4edda;
    border-color: #28a745;
}

.holiday-info-badge {
    background: #28a745;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-left: 1rem;
}

.optional-notice {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #856404;
}
</style>
<div id="validation_messages"></div>

<div class="container-fluid">
  <div class="page-header">
    <h1>
      <span class="icon-wrapper">
        <i class="fas fa-calendar-plus"></i>
      </span>
      Apply for Leave
    </h1>
    <p class="mb-0">Submit your leave application with ease</p>
  </div>

  <!-- NEW: Probation Alert -->
  {% if is_on_probation %}
  <div class="probation-alert">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <h5 class="mb-1">You are currently on probation</h5>
        <p class="mb-0">{{ probation_message }}</p>
        {% if employee.probation_end_date %}
        <small>Probation ends on: {{ employee.probation_end_date|date:"d M, Y" }}</small>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- NEW: Advance Notice Warning (Dynamic) -->
  <div class="advance-notice-warning" id="advance_notice_warning">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <div>
        <h5 class="mb-1" id="warning_title">Advance Notice Required</h5>
        <p class="mb-0" id="warning_message"></p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-file-alt"></i> Leave Application Form
          </h5>
        </div>

        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="leave_type" class="form-label">
                <i class="fas fa-list-alt"></i> Leave Type *
              </label>
              <select
                class="form-select"
                id="leave_type"
                name="leave_type"
                required
                {% if is_on_probation %}onchange="checkProbationLeaveType(this)"{% endif %}
              >
                <option value="">Select Leave Type</option>
                {% for leave_type in leave_types %}
                <option value="{{ leave_type.id }}" 
                        data-name="{{ leave_type.name }}"
                        {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}disabled{% endif %}>
                  {{ leave_type.name }}
                  {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}
                  -  Not allowed during probation
                  {% endif %}
                </option>
                {% endfor %}
              </select>
              <div class="leave-type-info" id="leave_type_info"></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-wallet"></i> Available Balance
              </label>
              <div id="balance-display" class="form-control">
                Select a leave type to see balance
              </div>
            </div>
          </div>

          <!-- Half Day Section -->
          <div class="half-day-section">
            <div class="half-day-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="half_day_toggle">
                <span class="toggle-slider"></span>
              </label>
              <label for="half_day_toggle" style="cursor: pointer; font-weight: 600; color: #2d3748;">
                <i class="fas fa-clock"></i> Half Day Leave
              </label>
            </div>
            
            <div class="half-options" id="half_options">
              <label class="form-label mb-2">
                <i class="fas fa-sun"></i> Select Half
              </label>
              <div class="d-flex gap-3">
                <label class="half-option-btn" for="first_half" id="first_half_label">
                  <input type="radio" name="half_day_period" value="first_half" id="first_half">
                  <i class="fas fa-cloud-sun"></i>
                  <div>First Half</div>
                  <small class="text-muted">Morning Session</small>
                </label>
                <label class="half-option-btn" for="second_half" id="second_half_label">
                  <input type="radio" name="half_day_period" value="second_half" id="second_half">
                  <i class="fas fa-moon"></i>
                  <div>Second Half</div>
                  <small class="text-muted">Evening Session</small>
                </label>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="start_date" class="form-label">
                <i class="fas fa-calendar-day"></i> Start Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="start_date"
                name="start_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="end_date" class="form-label">
                <i class="fas fa-calendar-check"></i> End Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="end_date"
                name="end_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
          </div>
          <!-- NEW: Optional Holidays Selection -->
          <div class="optional-holidays-section" id="optional_holidays_section">
            <div class="d-flex align-items-center mb-3">
              <!-- <i class="fas fa-star text-warning fa-2x me-2"></i> -->
              <div>
                <h5 class="mb-0">Optional Holidays Available</h5>
                <p class="mb-0 text-muted">Select which optional holidays you want to use for this leave</p>
              </div>
            </div>
            
            <div id="optional_holidays_list"></div>
            
            <div class="optional-notice">
              <i class="fas fa-info-circle"></i>
              <strong>Note:</strong> Selected optional holidays will be deducted from your Optional Leave balance. 
              The remaining days will be deducted from your selected leave type.
            </div>
          </div>


          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-calendar-alt"></i> Total Working Days
              </label>
              <div id="days-display" class="form-control">0 days</div>
              <small class="text-muted">Excludes weekends and holidays</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="attachment" class="form-label">
                <i class="fas fa-paperclip"></i> Attachment (Optional)
              </label>
              <input
                type="file"
                class="form-control"
                id="attachment"
                name="attachment"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              />
              <small class="text-muted">
                Max 5MB. Required for sick leave with medical certificate
              </small>
            </div>
          </div>

          <div class="mb-3">
            <label for="reason" class="form-label">
              <i class="fas fa-comment-dots"></i> Reason for Leave *
            </label>
            <textarea
              class="form-control"
              id="reason"
              name="reason"
              rows="4"
              placeholder="Please provide a detailed reason for your leave application..."
              required
            ></textarea>
          </div>

          <!-- Hidden fields for backend -->
          <input type="hidden" name="total_days" id="total_days" value="0">
          <input type="hidden" name="is_half_day" id="is_half_day" value="false">

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="submit_btn">
              <i class="fas fa-paper-plane"></i> Submit Application
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="history.back()"
            >
              <i class="fas fa-arrow-left"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-md-4">
      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </h5>
        </div>
        <div class="leave-balance-list">
          {% for balance in leave_balances %}
          <div class="balance-item mb-3 p-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold">{{ balance.leave_type.name }}</span>
              <span class="badge bg-primary">{{ balance.leaves_remaining }} days</span>
            </div>
            <small class="text-muted">
              Total: {{ balance.total_leaves|floatformat:1 }} days | Taken: {{ balance.leaves_taken|floatformat:1 }} days
              {% if balance.leave_type.name == 'Optional' %}
              <br><strong>Max usable: 2 days</strong>
              {% endif %}
              {% if balance.leave_type.name == 'Earned' %}
              <br>Monthly: 1.5 days
              {% endif %}
            </small>
          </div>
          {% empty %}
          <div class="text-center text-muted py-3">
            <i class="fas fa-info-circle fa-2x mb-2"></i>
            <p>No leave balance found</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="custom-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-lightbulb"></i> Quick Tips
          </h5>
        </div>
        <ul class="list-unstyled tips-list">
          <li>
            <i class="fas fa-check text-success"></i> Apply at least 3 days in advance
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Check your leave balance before applying
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Attach medical certificate for sick leave
          </li>
          <li>
            <i class="fas fa-check text-success"></i> Contact your manager for urgent leaves
          </li>
          {% if is_on_probation %}
          <li>
            <i class="fas fa-exclamation-triangle text-warning"></i> Probation restrictions apply
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('leave_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const balanceDisplay = document.getElementById('balance-display');
    const daysDisplay = document.getElementById('days-display');
    const halfDayToggle = document.getElementById('half_day_toggle');
    const halfOptions = document.getElementById('half_options');
    const firstHalfLabel = document.getElementById('first_half_label');
    const secondHalfLabel = document.getElementById('second_half_label');
    const firstHalfRadio = document.getElementById('first_half');
    const secondHalfRadio = document.getElementById('second_half');
    const leaveTypeInfo = document.getElementById('leave_type_info');
    const submitBtn = document.getElementById('submit_btn');
    const optionalHolidaysSection = document.getElementById('optional_holidays_section');
    const optionalHolidaysList = document.getElementById('optional_holidays_list');

    const leaveBalances = {
        {% for balance in leave_balances %}
        '{{ balance.leave_type.id }}': {
            'remaining': {{ balance.leaves_remaining }},
            'taken': {{ balance.leaves_taken }},
            'total': {{ balance.total_leaves }},
            'name': '{{ balance.leave_type.name }}',
            'is_optional': {% if balance.leave_type.is_optional %}true{% else %}false{% endif %},
            'max_carry_forward': {{ balance.leave_type.max_carry_forward }},
            'can_use_same_month': {% if balance.leave_type.can_use_same_month %}true{% else %}false{% endif %}
        },
        {% endfor %}
    };

    // üÜï Get mandatoryHolidays from backend
    const mandatoryHolidays = new Set({{ holiday_dates|safe }}.map(date => date));
    
    let currentOptionalHolidays = [];
    let selectedOptionalHolidays = [];
    let currentOptionalHolidayDates = new Set();
    let isOptionalLeaveTypeSelected = false;

    // üÜï Create validation message container
    const validationContainer = document.createElement('div');
    validationContainer.id = 'validation_messages';
    validationContainer.style.marginBottom = '1rem';
    document.querySelector('form').insertBefore(validationContainer, document.querySelector('form').firstChild);

    // Initialize Bootstrap Datepicker
    $(startDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("Start date selected:", e.format());
        if (halfDayToggle.checked) {
            const selectedDate = e.format();
            endDateInput.value = selectedDate;
            $(endDateInput).datepicker('setDate', e.date);
            $(endDateInput).datepicker('update');
        }
        calculateDaysAndFetchOptional();
        validateAllFields();
    });

    $(endDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("End date selected:", e.format());
        calculateDaysAndFetchOptional();
        validateAllFields();
    });

    // Parse DD-MM-YYYY format to Date object
    function parseDate(dateStr) {
        if (!dateStr || dateStr.trim() === '') return null;
        
        const parts = dateStr.trim().split('-');
        if (parts.length !== 3) return null;
        
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        
        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
        
        const date = new Date(year, month, day);
        
        if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
            return null;
        }
        
        return date;
    }

    // Convert Date to YYYY-MM-DD for comparison
    function dateToString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Convert DD-MM-YYYY to YYYY-MM-DD
    function formatDateForAPI(dateStr) {
        const date = parseDate(dateStr);
        return date ? dateToString(date) : null;
    }

    // üÜï Check if two date ranges overlap
    function datesOverlap(start1, end1, start2, end2) {
        return start1 <= end2 && end1 >= start2;
    }

    // üÜï Calculate working days excluding Sundays and mandatoryHolidays
    function calculateWorkingDays(startDate, endDate) {
        let workingDays = 0;
        let holidayCount = 0;
        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay();
            const dateStr = dateToString(currentDate);
            
            // Check if it's a holiday
            const isHoliday = mandatoryHolidays.has(dateStr);
            
            // Exclude Sundays (0) and mandatoryHolidays
            if (dayOfWeek !== 0 && !isHoliday) {
                workingDays++;
            } else if (isHoliday) {
                holidayCount++;
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }

        return { workingDays, holidayCount };
    }

    // üÜï Check if dates contain optional holidays
    function checkDatesForOptionalHolidays(startDate, endDate) {
        if (!currentOptionalHolidayDates.size) return false;
        
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dateStr = dateToString(currentDate);
            if (currentOptionalHolidayDates.has(dateStr)) {
                return true;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return false;
    }

    // üÜï Comprehensive validation function
    function validateAllFields() {
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;
        const isHalfDay = halfDayToggle.checked;

        // Clear previous messages
        validationContainer.innerHTML = '';
        submitBtn.disabled = false;

        // Don't validate if fields are empty
        if (!startDateStr || !endDateStr || startDateStr === 'DD-MM-YYYY' || endDateStr === 'DD-MM-YYYY') {
            return;
        }

        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        if (!startDate || !endDate) {
            showError(' Invalid date format. Please use DD-MM-YYYY format.');
            return;
        }

        let hasErrors = false;

        // 1Ô∏è‚É£ Check if dates are in the past
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (startDate < today) {
            showError(' Cannot apply for leave in the past');
            hasErrors = true;
        }

        // 2Ô∏è‚É£ Check if end_date is before start_date
        if (endDate < startDate) {
            showError(' End date cannot be before start date');
            hasErrors = true;
        }

        // 3Ô∏è‚É£ Calculate working days
        let workingDaysResult;
        if (isHalfDay) {
            workingDaysResult = { workingDays: 0.5, holidayCount: 0 };
        } else {
            workingDaysResult = calculateWorkingDays(startDate, endDate);
        }

        const workingDays = workingDaysResult.workingDays;
        const holidayCount = workingDaysResult.holidayCount;

        // 4Ô∏è‚É£ Check if there are any working days
        if (workingDays <= 0 && !isHalfDay) {
            showError(' No working days in selected range (all days are holidays/Sundays)');
            hasErrors = true;
        }

        // 5Ô∏è‚É£ SPECIAL VALIDATION: If Optional Leave type is selected, check if dates contain optional holidays
        if (isOptionalLeaveTypeSelected && !isHalfDay) {
            const hasOptionalHolidays = checkDatesForOptionalHolidays(startDate, endDate);
            
            if (!hasOptionalHolidays) {
                showError(' ‚ùå Cannot use Optional Leave type for selected dates. The selected date range does not contain any optional holidays. Please select a different leave type or choose dates that include optional holidays.');
                hasErrors = true;
                submitBtn.disabled = true;
            } else {
                showInfo(' ‚úÖ Selected dates contain optional holidays. This will be processed as Optional Leave.');
            }
        }

        // 6Ô∏è‚É£ Check advance notice (7 days for 3+ days, 15 days for 7+ days)
        if (!isHalfDay && !hasErrors) {
            const daysUntilStart = Math.floor((startDate - today) / (1000 * 60 * 60 * 24));
            
            if (workingDays >= 7 && daysUntilStart < 15) {
                showWarning(
                    ` Advance notice required: For ${workingDays} working days leave, ` +
                    `please apply at least 15 days in advance. ` +
                    `(Currently ${daysUntilStart} days in advance)`
                );
            } else if (workingDays >= 3 && workingDays < 7 && daysUntilStart < 7) {
                showWarning(
                    ` Advance notice required: For ${workingDays} working days leave, ` +
                    `please apply at least 7 days in advance. ` +
                    `(Currently ${daysUntilStart} days in advance)`
                );
            }
        }

        // Show holiday info
        if (holidayCount > 0 && !hasErrors && !isHalfDay) {
            showInfo(`‚ÑπÔ∏è ${holidayCount} holiday(s) excluded from working days calculation`);
        }

        // Disable submit if errors exist
        if (hasErrors) {
            submitBtn.disabled = true;
        }
    }

    // üÜï Helper functions to show messages
    function showError(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showWarning(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showInfo(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showSuccess(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    async function calculateDaysAndFetchOptional() {
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;

        if (!startDateStr || !endDateStr || startDateStr === 'DD-MM-YYYY' || endDateStr === 'DD-MM-YYYY') {
            daysDisplay.textContent = '0 days';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        if (!startDate || !endDate || endDate < startDate) {
            daysDisplay.textContent = 'Invalid dates';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        // Check if half-day
        if (halfDayToggle.checked) {
            daysDisplay.innerHTML = '<span class="fw-bold text-primary">0.5 days</span>';
            document.getElementById('total_days').value = '0.5';
            document.getElementById('is_half_day').value = 'true';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        // Fetch optional holidays from backend
        try {
            const response = await fetch(
                `/leave/api/optional-holidays/?start_date=${dateToString(startDate)}&end_date=${dateToString(endDate)}`
            );
            const data = await response.json();

            if (data.success) {
                currentOptionalHolidays = data.optional_holidays;
                currentOptionalHolidayDates = new Set(currentOptionalHolidays.map(h => h.date));
                const workingDays = data.working_days;

                // Show optional holidays section if:
                // 1. There are optional holidays in the range
                // 2. Leave type is NOT already "Optional Leave"
                const leaveTypeName = leaveTypeSelect.options[leaveTypeSelect.selectedIndex]?.dataset.name || '';
                const isOptionalLeaveType = leaveTypeName.toLowerCase().includes('optional');
                isOptionalLeaveTypeSelected = isOptionalLeaveType;

                if (currentOptionalHolidays.length > 0 && !isOptionalLeaveType) {
                    displayOptionalHolidays();
                    optionalHolidaysSection.classList.add('show');
                } else {
                    optionalHolidaysSection.classList.remove('show');
                    selectedOptionalHolidays = [];
                }

                updateDaysDisplay(workingDays, data.mandatory_holidays_count);
                
                // Trigger validation after fetching optional holidays
                validateAllFields();
            }
        } catch (error) {
            console.error('Error fetching optional holidays:', error);
        }
    }

    function displayOptionalHolidays() {
        optionalHolidaysList.innerHTML = '';

        currentOptionalHolidays.forEach(holiday => {
            const isSelected = selectedOptionalHolidays.includes(holiday.date);
            const holidayDate = new Date(holiday.date);
            const formattedDate = holidayDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });

            const itemDiv = document.createElement('div');
            itemDiv.className = `optional-holiday-item ${isSelected ? 'selected' : ''}`;
            itemDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <input type="checkbox" 
                           name="optional_holidays" 
                           value="${holiday.date}" 
                           class="optional-holiday-checkbox me-3"
                           ${isSelected ? 'checked' : ''}
                           id="opt_${holiday.date}">
                    <label for="opt_${holiday.date}" class="flex-grow-1 mb-0" style="cursor: pointer;">
                        <strong>${holiday.name}</strong>
                        <span class="holiday-info-badge">${formattedDate}</span>
                        <br>
                        <small class="text-muted">${holiday.region}</small>
                    </label>
                </div>
            `;

            itemDiv.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = itemDiv.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            const checkbox = itemDiv.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    itemDiv.classList.add('selected');
                    if (!selectedOptionalHolidays.includes(holiday.date)) {
                        selectedOptionalHolidays.push(holiday.date);
                    }
                } else {
                    itemDiv.classList.remove('selected');
                    selectedOptionalHolidays = selectedOptionalHolidays.filter(d => d !== holiday.date);
                }
                updateDaysDisplayWithOptional();
            });

            optionalHolidaysList.appendChild(itemDiv);
        });
    }

    function updateDaysDisplay(workingDays, mandatoryCount) {
        document.getElementById('total_days').value = workingDays.toString();
        document.getElementById('is_half_day').value = 'false';

        daysDisplay.innerHTML = `<span class="fw-bold">${workingDays} days</span>`;
        if (mandatoryCount > 0) {
            daysDisplay.innerHTML += `<small class="text-muted d-block">${mandatoryCount} mandatory holiday(s) excluded</small>`;
        }
    }

    function updateDaysDisplayWithOptional() {
        const totalDaysInput = document.getElementById('total_days');
        const currentWorkingDays = parseFloat(totalDaysInput.value) || 0;
        const optionalCount = selectedOptionalHolidays.length;
        const adjustedDays = currentWorkingDays - optionalCount;

        daysDisplay.innerHTML = `<span class="fw-bold">${adjustedDays} days</span>`;
        
        if (optionalCount > 0) {
            daysDisplay.innerHTML += `
                <br><small class="text-success">‚úì Using ${optionalCount} optional holiday(s)</small>
                <br><small class="text-muted">${adjustedDays} from ${leaveTypeSelect.options[leaveTypeSelect.selectedIndex]?.text || 'selected leave'}, 
                ${optionalCount} from Optional Leave</small>
            `;
        }
    }

    // Update balance display
    leaveTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const leaveTypeName = selectedOption ? selectedOption.dataset.name || '' : '';
        isOptionalLeaveTypeSelected = leaveTypeName.toLowerCase().includes('optional');
        
        if (selectedType && leaveBalances[selectedType]) {
            const balance = leaveBalances[selectedType];
            let infoHtml = '';
            
            if (balance.is_optional) {
                const remainingUsable = Math.max(0, 2 - balance.taken);
                infoHtml = `<span class="text-info">Max usable: ${remainingUsable} days remaining</span>`;
            }
            
            if (!balance.can_use_same_month) {
                infoHtml += `<br><span class="text-warning">Cannot use in same month as accrual</span>`;
            }
            
            balanceDisplay.innerHTML = `
                <span class="text-success fw-bold">${balance.remaining} days available</span>
                <small class="d-block text-muted">(Total: ${balance.total}, Taken: ${balance.taken})</small>
                ${infoHtml}
            `;
            
            leaveTypeInfo.innerHTML = infoHtml;
            
            // If Optional Leave type is selected, show warning
            if (isOptionalLeaveTypeSelected) {
                const startDateStr = startDateInput.value;
                const endDateStr = endDateInput.value;
                
                if (startDateStr && endDateStr && startDateStr !== 'DD-MM-YYYY' && endDateStr !== 'DD-MM-YYYY') {
                    showInfo('‚ö†Ô∏è Note: Optional Leave type can only be used for dates that are optional holidays.');
                }
            }
            
            // Hide optional holidays section if Optional Leave type is selected
            if (isOptionalLeaveTypeSelected) {
                optionalHolidaysSection.classList.remove('show');
                selectedOptionalHolidays = [];
            }
        } else {
            balanceDisplay.textContent = 'Select a leave type to see balance';
            leaveTypeInfo.innerHTML = '';
        }
        
        validateAllFields();
    });

    // Half day toggle
    halfDayToggle.addEventListener('change', function() {
        if (this.checked) {
            halfOptions.classList.add('active');
            
            if (startDateInput.value && startDateInput.value !== 'DD-MM-YYYY') {
                endDateInput.value = startDateInput.value;
                const startDate = parseDate(startDateInput.value);
                if (startDate) {
                    $(endDateInput).datepicker('setDate', startDate);
                    $(endDateInput).datepicker('update');
                }
            }
            
            endDateInput.disabled = true;
            endDateInput.readOnly = true;
            $(endDateInput).datepicker('disable');
            
            calculateDaysAndFetchOptional();
            validateAllFields();
        } else {
            halfOptions.classList.remove('active');
            firstHalfRadio.checked = false;
            secondHalfRadio.checked = false;
            firstHalfLabel.classList.remove('selected');
            secondHalfLabel.classList.remove('selected');
            
            endDateInput.disabled = false;
            endDateInput.readOnly = false;
            $(endDateInput).datepicker('enable');
            
            calculateDaysAndFetchOptional();
            validateAllFields();
        }
    });

    // Half day option selection
    firstHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            firstHalfLabel.classList.add('selected');
            secondHalfLabel.classList.remove('selected');
        }
    });

    secondHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            secondHalfLabel.classList.add('selected');
            firstHalfLabel.classList.remove('selected');
        }
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const totalDays = document.getElementById('total_days').value;
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;
        const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
        const leaveTypeName = selectedOption ? selectedOption.dataset.name || '' : '';
        const isOptionalLeaveType = leaveTypeName.toLowerCase().includes('optional');
        
        // Final validation before submission
        if (halfDayToggle.checked) {
            if (!firstHalfRadio.checked && !secondHalfRadio.checked) {
                e.preventDefault();
                alert('Please select either First Half or Second Half for half-day leave.');
                return false;
            }
            if (parseFloat(totalDays) <= 0) {
                e.preventDefault();
                alert('Please select valid dates.');
                return false;
            }
        }
        
        // Validate Optional Leave type selection
        if (isOptionalLeaveType && startDateStr && endDateStr) {
            const startDate = parseDate(startDateStr);
            const endDate = parseDate(endDateStr);
            
            if (startDate && endDate) {
                const hasOptionalHolidays = checkDatesForOptionalHolidays(startDate, endDate);
                
                if (!hasOptionalHolidays) {
                    e.preventDefault();
                    alert('‚ùå Cannot use Optional Leave type for selected dates. The selected date range does not contain any optional holidays. Please select a different leave type or choose dates that include optional holidays.');
                    return false;
                }
            }
        }
        
        // Check if there are any validation errors
        const errorAlerts = validationContainer.querySelectorAll('.alert-danger');
        if (errorAlerts.length > 0) {
            e.preventDefault();
            alert('Please fix the validation errors before submitting.');
            return false;
        }
    });
});
</script>
{% endblock %}