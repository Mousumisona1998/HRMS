{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --primary: #4361ee;
        --primary-light: #4895ef;
        --secondary: #7209b7;
        --accent: #4cc9f0;
        --warning: #f72585;
        --success: #10b981;
        --dark: #1a1a2e;
        --light: #f8f9fa;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;
        --white: #ffffff;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: #f8fafc;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: var(--gray-800);
    }

    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 24px;
    }

    /* Header Styles */
    .page-header {
        /* background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); */
        color: black;
        padding: 0px 0px;
        /* border-radius: 20px; */
        margin-bottom: 32px;
        /* box-shadow: var(--card-shadow); */
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        /* background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); */
        /* animation: shimmer 3s infinite linear; */
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .page-header h1 {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
    }

    .page-header p {
        font-size: 16px;
        opacity: 0.9;
        font-weight: 400;
        position: relative;
        z-index: 1;
    }

    .icon-wrapper {
        background: #74d1ff;
        width: 47px;
        height: 50px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .icon-wrapper i {
        font-size: 24px;
        color: var(--white);
    }

    /* Card Styles */
    .custom-card {
        background: var(--white);
        border-radius: 20px;
        padding: 32px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .custom-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--hover-shadow);
        border-color: var(--primary-light);
    }

    .custom-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .card-header {
        margin: -32px -32px 32px -32px;
        padding: 24px 32px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid var(--gray-200);
        border-radius: 20px 20px 0 0;
    }

    .card-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .card-title i {
        color: var(--primary);
        font-size: 20px;
    }

    /* Form Styles */
    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-label i {
        color: var(--primary);
        font-size: 16px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid var(--gray-300);
        border-radius: 12px;
        font-size: 15px;
        color: var(--gray-800);
        background: var(--white);
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }

    /* Half Day Section */
    .half-day-section {
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(114, 9, 183, 0.05) 100%);
        border: 2px dashed var(--gray-300);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
    }

    .half-day-section:hover {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.08) 0%, rgba(114, 9, 183, 0.08) 100%);
    }

    .half-day-toggle {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .toggle-switch {
        position: relative;
        width: 64px;
        height: 32px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--gray-300);
        transition: .4s;
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    input:checked + .toggle-slider {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    input:checked + .toggle-slider:before {
        transform: translateX(32px);
    }

    .half-options {
        display: none;
        margin-top: 16px;
    }

    .half-options.active {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .half-option-btn {
        flex: 1;
        padding: 20px;
        border: 2px solid var(--gray-300);
        border-radius: 12px;
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .half-option-btn:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.1);
    }

    .half-option-btn.selected {
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(114, 9, 183, 0.1) 100%);
        border-color: var(--primary);
        color: var(--primary);
    }

    .half-option-btn i {
        font-size: 24px;
        margin-bottom: 8px;
        color: inherit;
    }

    .half-option-btn div {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
    }

    .half-option-btn small {
        font-size: 12px;
        opacity: 0.7;
    }

    /* Alerts */
    .probation-alert {
        background: linear-gradient(135deg, rgba(247, 37, 133, 0.1) 0%, rgba(247, 37, 133, 0.05) 100%);
        border: 2px solid rgba(247, 37, 133, 0.3);
        border-radius: 16px;
        padding: 20px 24px;
        margin-bottom: 24px;
        color: var(--warning);
        position: relative;
        overflow: hidden;
    }

    .probation-alert::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--warning);
    }

    .advance-notice-warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 235, 59, 0.05) 100%);
        border: 2px solid rgba(255, 193, 7, 0.3);
        border-radius: 16px;
        padding: 20px 24px;
        margin-bottom: 24px;
        color: #856404;
        display: none;
        position: relative;
        overflow: hidden;
    }

    .advance-notice-warning::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: #ffc107;
    }

    .advance-notice-warning.show {
        display: block;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .warning-icon {
        color: #ffc107;
        font-size: 24px;
    }

    /* Optional Holidays Section */
    .optional-holidays-section {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        border: 2px solid rgba(16, 185, 129, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        display: none;
        position: relative;
        overflow: hidden;
    }

    .optional-holidays-section::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--success);
    }

    .optional-holidays-section.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .optional-holiday-item {
        background: var(--white);
        border: 2px solid var(--gray-300);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .optional-holiday-item:hover {
        border-color: var(--success);
        transform: translateX(8px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    }

    .optional-holiday-item.selected {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        border-color: var(--success);
    }

    .holiday-info-badge {
        background: var(--success);
        color: var(--white);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-left: 8px;
    }

    .optional-notice {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
        font-size: 14px;
        color: #856404;
    }

    /* Leave Balance */
    .balance-item {
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(114, 9, 183, 0.05) 100%);
        border: 2px solid transparent;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .balance-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.1);
    }

    .badge {
        background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }

    /* Special Display Elements */
    #balance-display {
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(114, 9, 183, 0.1) 100%);
        border: 2px solid var(--gray-200);
        font-weight: 600;
        color: var(--primary);
        min-height: 52px;
        display: flex;
        align-items: center;
        padding: 12px 16px;
    }

    #days-display {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        border: 2px solid var(--gray-200);
        font-weight: 600;
        color: var(--success);
        min-height: 52px;
        display: flex;
        align-items: center;
        padding: 12px 16px;
    }


    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
    }

    .btn-secondary {
        background: var(--gray-200);
        color: var(--gray-800);
        border: 2px solid var(--gray-300);
    }

    .btn-secondary:hover {
        background: var(--gray-300);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Tips List */
    .tips-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .tips-list li {
        padding: 16px;
        background: var(--gray-100);
        border-radius: 12px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        font-size: 14px;
        color: var(--gray-700);
        border-left: 4px solid transparent;
    }

    .tips-list li:hover {
        background: var(--white);
        border-left-color: var(--primary);
        transform: translateX(8px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .tips-list li i {
        color: var(--success);
        font-size: 16px;
        margin-top: 2px;
    }

    /* Validation Messages */
    #validation_messages {
        margin-bottom: 24px;
    }

    .alert {
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 12px;
        border: 2px solid transparent;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease;
    }

    .alert i {
        font-size: 18px;
        margin-top: 2px;
    }

    .alert-danger {
        background: linear-gradient(135deg, rgba(247, 37, 133, 0.1) 0%, rgba(247, 37, 133, 0.05) 100%);
        border-color: rgba(247, 37, 133, 0.3);
        color: var(--warning);
    }

    .alert-warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 235, 59, 0.05) 100%);
        border-color: rgba(255, 193, 7, 0.3);
        color: #856404;
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(76, 201, 240, 0.1) 0%, rgba(76, 201, 240, 0.05) 100%);
        border-color: rgba(76, 201, 240, 0.3);
        color: var(--accent);
    }

    .alert-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        border-color: rgba(16, 185, 129, 0.3);
        color: var(--success);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-container {
            padding: 16px;
        }
        
        .page-header {
            padding: 0px;
        }
        
        .page-header h1 {
            font-size: 28px;
        }
        
        .custom-card {
            padding: 24px;
        }
        
        .card-header {
            margin: -24px -24px 24px -24px;
            padding: 20px 24px;
        }
        
        .half-option-btn {
            padding: 16px;
        }
        
    }

    @media (max-width: 576px) {
        .row {
            margin-left: -8px;
            margin-right: -8px;
        }
        
        .col-md-8, .col-md-4, .col-md-6 {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .page-header h1 {
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
        }
        
        .icon-wrapper {
            width: 48px;
            height: 48px;
        }
    }

    /* Loading States */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 3px solid var(--primary);
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* File Upload Styling */
    .file-upload {
        position: relative;
        overflow: hidden;
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 16px;
        background: var(--gray-100);
        transition: all 0.3s ease;
    }

    .file-upload:hover {
        border-color: var(--primary);
        background: rgba(67, 97, 238, 0.05);
    }

    /* Leave Type Info */
    .leave-type-info {
        font-size: 13px;
        color: var(--gray-600);
        margin-top: 4px;
        padding: 8px 12px;
        background: var(--gray-100);
        border-radius: 8px;
        border-left: 3px solid var(--primary);
    }

    /* Radio and Checkbox Custom Styles */
    input[type="radio"], 
    input[type="checkbox"] {
        accent-color: var(--primary);
    }

    /* Placeholder Styling */
    ::placeholder {
        color: var(--gray-500);
        opacity: 1;
    }

    :-ms-input-placeholder {
        color: var(--gray-500);
    }

    ::-ms-input-placeholder {
        color: var(--gray-500);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--gray-100);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--gray-400);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-500);
    }

    /* Focus Outline */
    *:focus {
        outline: 2px solid var(--primary-light);
        outline-offset: 2px;
    }

    *:focus:not(.focus-visible) {
        outline: none;
    }

    /* Animation Classes */
    .fade-in {
        animation: fadeIn 0.5s ease;
    }

    .slide-up {
        animation: slideUp 0.4s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Utility Classes */
    .text-gradient {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
</style>

<div id="validation_messages"></div>

<div class="page-container">
  <div class="page-header fade-in">
    <h1>
      <span class="icon-wrapper">
        <i class="fas fa-calendar-plus"></i>
      </span>
      Apply for Leave
    </h1>
    <p class="mb-0">Submit your leave application with ease</p>
  </div>

  <!-- NEW: Probation Alert -->
  {% if is_on_probation %}
  <div class="probation-alert slide-up">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle fa-lg"></i>
      <div class="ms-3">
        <h5 class="mb-1">You are currently on probation</h5>
        <p class="mb-0">{{ probation_message }}</p>
        {% if employee.probation_end_date %}
        <small class="d-block mt-1">Probation ends on: {{ employee.probation_end_date|date:"d M, Y" }}</small>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- NEW: Advance Notice Warning (Dynamic) -->
  <div class="advance-notice-warning" id="advance_notice_warning">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <div class="ms-3">
        <h5 class="mb-1" id="warning_title">Advance Notice Required</h5>
        <p class="mb-0" id="warning_message"></p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="custom-card slide-up">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-file-alt"></i> Leave Application Form
          </h5>
        </div>

        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="leave_type" class="form-label">
                <i class="fas fa-list-alt"></i> Leave Type *
              </label>
              <select
                class="form-select"
                id="leave_type"
                name="leave_type"
                required
                {% if is_on_probation %}onchange="checkProbationLeaveType(this)"{% endif %}
              >
                <option value="">Select Leave Type</option>
                {% for leave_type in leave_types %}
                <option value="{{ leave_type.id }}" 
                        data-name="{{ leave_type.name }}"
                        {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}disabled{% endif %}>
                  {{ leave_type.name }}
                  {% if is_on_probation and leave_type.name not in 'Unpaid,CompOff' %}
                  -  Not allowed during probation
                  {% endif %}
                </option>
                {% endfor %}
              </select>
              <!-- <div class="leave-type-info" id="leave_type_info"></div> -->
            </div>
            <div class="col-md-6 mb-4">
              <label class="form-label">
                <i class="fas fa-wallet"></i> Available Balance
              </label>
              <div id="balance-display" class="form-control">
                Select a leave type to see balance
              </div>
            </div>
          </div>

          <!-- Half Day Section -->
          <div class="half-day-section">
            <div class="half-day-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="half_day_toggle">
                <span class="toggle-slider"></span>
              </label>
              <label for="half_day_toggle" style="cursor: pointer; font-weight: 600; color: var(--dark);">
                <i class="fas fa-clock"></i> Half Day Leave
              </label>
            </div>
            
            <div class="half-options" id="half_options">
              <label class="form-label mb-3">
                <i class="fas fa-sun"></i> Select Half
              </label>
              <div class="d-flex gap-3">
                <label class="half-option-btn" for="first_half" id="first_half_label">
                  <input type="radio" name="half_day_period" value="first_half" id="first_half">
                  <i class="fas fa-cloud-sun"></i>
                  <div>First Half</div>
                  <small class="text-muted">Morning Session</small>
                </label>
                <label class="half-option-btn" for="second_half" id="second_half_label">
                  <input type="radio" name="half_day_period" value="second_half" id="second_half">
                  <i class="fas fa-moon"></i>
                  <div>Second Half</div>
                  <small class="text-muted">Evening Session</small>
                </label>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="start_date" class="form-label">
                <i class="fas fa-calendar-day"></i> Start Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="start_date"
                name="start_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
            <div class="col-md-6 mb-4">
              <label for="end_date" class="form-label">
                <i class="fas fa-calendar-check"></i> End Date *
              </label>
              <input
                type="text"
                class="form-control datepicker"
                id="end_date"
                name="end_date"
                placeholder="DD-MM-YYYY"
                min="{{ min_date }}"
                required
              />
            </div>
          </div>
          
          <!-- NEW: Optional Holidays Selection -->
          <div class="optional-holidays-section" id="optional_holidays_section">
            <div class="d-flex align-items-center mb-4">
              <div>
                <h5 class="mb-1">Optional Holidays Available</h5>
                <p class="mb-0 text-muted">Select which optional holidays you want to use for this leave</p>
              </div>
            </div>
            
            <div id="optional_holidays_list"></div>
            
            <div class="optional-notice">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Note:</strong> Selected optional holidays will be deducted from your Optional Leave balance. 
              The remaining days will be deducted from your selected leave type.
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label">
                <i class="fas fa-calendar-alt"></i> Total Working Days
              </label>
              <div id="days-display" class="form-control">0 days</div>
              <small class="text-muted d-block mt-1">Excludes weekends and holidays</small>
            </div>
            <div class="col-md-6 mb-4">
              <label for="attachment" class="form-label">
                <i class="fas fa-paperclip"></i> Attachment (Optional)
              </label>
              <input
                type="file"
                class="form-control"
                id="attachment"
                name="attachment"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              />
              <small class="text-muted d-block mt-1">
                Max 5MB. Required for sick leave with medical certificate
              </small>
            </div>
          </div>

          <div class="mb-4">
            <label for="reason" class="form-label">
              <i class="fas fa-comment-dots"></i> Reason for Leave *
            </label>
            <textarea
              class="form-control"
              id="reason"
              name="reason"
              rows="4"
              placeholder="Please provide a detailed reason for your leave application..."
              required
            ></textarea>
          </div>

          <!-- Hidden fields for backend -->
          <input type="hidden" name="total_days" id="total_days" value="0">
          <input type="hidden" name="is_half_day" id="is_half_day" value="false">

          <div class="d-flex gap-3">
            <button type="submit" class="btn btn-primary" id="submit_btn">
              <i class="fas fa-paper-plane me-2"></i> Submit Application
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="history.back()"
            >
              <i class="fas fa-arrow-left me-2"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-md-4">
      <div class="custom-card slide-up">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-chart-pie"></i> Leave Balance
          </h5>
        </div>
        <div class="leave-balance-list">
          {% for balance in leave_balances %}
          <div class="balance-item">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-bold">{{ balance.leave_type.name }}</span>
              <span class="badge">{{ balance.leaves_remaining }} days</span>
            </div>
            <small class="text-muted d-block">
              Total: {{ balance.total_leaves|floatformat:1 }} days | Taken: {{ balance.leaves_taken|floatformat:1 }} days
              {% if balance.leave_type.name == 'Optional' %}
              <br><strong class="text-success">Max usable: 2 days</strong>
              {% endif %}
              {% if balance.leave_type.name == 'Earned' %}
              <br>Monthly: 1.5 days
              {% endif %}
            </small>
          </div>
          {% empty %}
          <div class="text-center text-muted py-3">
            <i class="fas fa-info-circle fa-2x mb-2"></i>
            <p>No leave balance found</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="custom-card slide-up">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-lightbulb"></i> Quick Tips
          </h5>
        </div>
        <ul class="tips-list">
          <li>
            <i class="fas fa-check"></i> Apply at least 3 days in advance
          </li>
          <li>
            <i class="fas fa-check"></i> Check your leave balance before applying
          </li>
          <li>
            <i class="fas fa-check"></i> Attach medical certificate for sick leave
          </li>
          <li>
            <i class="fas fa-check"></i> Contact your manager for urgent leaves
          </li>
          {% if is_on_probation %}
          <li>
            <i class="fas fa-exclamation-triangle text-warning"></i> Probation restrictions apply
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('leave_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const balanceDisplay = document.getElementById('balance-display');
    const daysDisplay = document.getElementById('days-display');
    const halfDayToggle = document.getElementById('half_day_toggle');
    const halfOptions = document.getElementById('half_options');
    const firstHalfLabel = document.getElementById('first_half_label');
    const secondHalfLabel = document.getElementById('second_half_label');
    const firstHalfRadio = document.getElementById('first_half');
    const secondHalfRadio = document.getElementById('second_half');
    const leaveTypeInfo = document.getElementById('leave_type_info');
    const submitBtn = document.getElementById('submit_btn');
    const optionalHolidaysSection = document.getElementById('optional_holidays_section');
    const optionalHolidaysList = document.getElementById('optional_holidays_list');

    const leaveBalances = {
        {% for balance in leave_balances %}
        '{{ balance.leave_type.id }}': {
            'remaining': {{ balance.leaves_remaining }},
            'taken': {{ balance.leaves_taken }},
            'total': {{ balance.total_leaves }},
            'name': '{{ balance.leave_type.name }}',
            'is_optional': {% if balance.leave_type.is_optional %}true{% else %}false{% endif %},
            'max_carry_forward': {{ balance.leave_type.max_carry_forward }},
            'can_use_same_month': {% if balance.leave_type.can_use_same_month %}true{% else %}false{% endif %}
        },
        {% endfor %}
    };

    // Get mandatoryHolidays from backend
    const mandatoryHolidays = new Set({{ holiday_dates|safe }}.map(date => date));
    
    let currentOptionalHolidays = [];
    let selectedOptionalHolidays = [];
    let currentOptionalHolidayDates = new Set();
    let isOptionalLeaveTypeSelected = false;
    let existingLeaves = []; // Store existing leaves for overlap checking

    // Create validation message container
    const validationContainer = document.createElement('div');
    validationContainer.id = 'validation_messages';
    validationContainer.style.marginBottom = '1rem';
    document.querySelector('form').insertBefore(validationContainer, document.querySelector('form').firstChild);

    // Initialize Bootstrap Datepicker
    $(startDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("Start date selected:", e.format());
        if (halfDayToggle.checked) {
            const selectedDate = e.format();
            endDateInput.value = selectedDate;
            $(endDateInput).datepicker('setDate', e.date);
            $(endDateInput).datepicker('update');
        }
        calculateDaysAndFetchOptional();
        validateAllFields();
    });

    $(endDateInput).datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        startDate: '0d'
    }).on('changeDate', function(e) {
        console.log("End date selected:", e.format());
        calculateDaysAndFetchOptional();
        validateAllFields();
    });

    // Parse DD-MM-YYYY format to Date object
    function parseDate(dateStr) {
        if (!dateStr || dateStr.trim() === '') return null;
        
        const parts = dateStr.trim().split('-');
        if (parts.length !== 3) return null;
        
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        
        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
        
        const date = new Date(year, month, day);
        
        if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
            return null;
        }
        
        return date;
    }

    // Convert Date to YYYY-MM-DD for comparison
    function dateToString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Convert DD-MM-YYYY to YYYY-MM-DD
    function formatDateForAPI(dateStr) {
        const date = parseDate(dateStr);
        return date ? dateToString(date) : null;
    }

    // Check if two date ranges overlap (including single days)
function datesOverlap(start1, end1, start2, end2) {
    // Convert to timestamps for easier comparison
    const s1 = start1.getTime();
    const e1 = end1.getTime();
    const s2 = start2.getTime();
    const e2 = end2.getTime();
    
    // Two date ranges overlap if:
    // 1. Start1 is between Start2 and End2 (inclusive), OR
    // 2. End1 is between Start2 and End2 (inclusive), OR
    // 3. Start2 is between Start1 and End1 (inclusive), OR
    // 4. End2 is between Start1 and End1 (inclusive)
    return (s1 >= s2 && s1 <= e2) ||   // start1 within range2
           (e1 >= s2 && e1 <= e2) ||   // end1 within range2
           (s2 >= s1 && s2 <= e1) ||   // start2 within range1
           (e2 >= s1 && e2 <= e1);     // end2 within range1
}
    // Fetch existing leaves from backend
async function fetchExistingLeaves() {
    try {
        const response = await fetch('/leave/api/get-existing-leaves/');
        const data = await response.json();
        
        if (data.success && data.leaves) {
            existingLeaves = data.leaves.map(leave => {
                console.log('Parsing leave:', leave);
                
                // Parse ISO date strings
                let startDate, endDate;
                
                try {
                    // Handle ISO format: YYYY-MM-DD
                    if (leave.start_date) {
                        const startParts = leave.start_date.split('-');
                        startDate = new Date(
                            parseInt(startParts[0]),
                            parseInt(startParts[1]) - 1,
                            parseInt(startParts[2])
                        );
                    }
                    
                    if (leave.end_date) {
                        const endParts = leave.end_date.split('-');
                        endDate = new Date(
                            parseInt(endParts[0]),
                            parseInt(endParts[1]) - 1,
                            parseInt(endParts[2])
                        );
                    }
                } catch (e) {
                    console.error('Error parsing leave dates:', e, leave);
                    return null;
                }
                
                // Validate dates
                if (!startDate || !endDate || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    console.error('Invalid dates in leave:', leave);
                    return null;
                }
                
                return {
                    ...leave,
                    start_date: startDate,
                    end_date: endDate
                };
            }).filter(leave => leave !== null); // Remove invalid entries
            
            console.log('Existing leaves loaded:', existingLeaves.map(l => ({
                id: l.id,
                start_date: dateToString(l.start_date),
                end_date: dateToString(l.end_date),
                type: l.leave_type_name,
                status: l.status,
                is_half_day: l.is_half_day
            })));
        }
    } catch (error) {
        console.error('Error fetching existing leaves:', error);
    }
}

    // Check for overlapping leaves (including half-day considerations)
function checkForOverlappingLeaves(startDate, endDate, isHalfDay = false, halfPeriod = null) {
    if (!existingLeaves.length) {
        return { hasOverlap: false, overlappingLeaves: [] };
    }
    
    const overlappingLeaves = existingLeaves.filter(leave => {
        // Check if the leave status is pending or approved
        const isActiveLeave = leave.status === 'pending' || leave.status === 'approved';
        
        if (!isActiveLeave) return false;
        
        // Handle half-day overlap logic
        if (isHalfDay && leave.is_half_day) {
            // If both are half-day on the same date
            if (startDate.getTime() === leave.start_date.getTime() && 
                endDate.getTime() === leave.end_date.getTime()) {
                // Same day, check if periods overlap (both first half or both second half)
                return halfPeriod === leave.half_day_period;
            }
        } else if (isHalfDay && !leave.is_half_day) {
            // Current is half-day, existing is full day - overlap exists
            return datesOverlap(startDate, endDate, leave.start_date, leave.end_date);
        } else if (!isHalfDay && leave.is_half_day) {
            // Current is full day, existing is half-day - overlap exists
            return datesOverlap(startDate, endDate, leave.start_date, leave.end_date);
        }
        
        // Standard date range overlap check (works for single day too)
        return datesOverlap(startDate, endDate, leave.start_date, leave.end_date);
    });
    
    return {
        hasOverlap: overlappingLeaves.length > 0,
        overlappingLeaves: overlappingLeaves
    };
}

    // Calculate working days excluding Sundays and mandatoryHolidays
    function calculateWorkingDays(startDate, endDate) {
        let workingDays = 0;
        let holidayCount = 0;
        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay();
            const dateStr = dateToString(currentDate);
            
            // Check if it's a holiday
            const isHoliday = mandatoryHolidays.has(dateStr);
            
            // Exclude Sundays (0) and mandatoryHolidays
            if (dayOfWeek !== 0 && !isHoliday) {
                workingDays++;
            } else if (isHoliday) {
                holidayCount++;
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }

        return { workingDays, holidayCount };
    }

    // Check if dates contain optional holidays
    function checkDatesForOptionalHolidays(startDate, endDate) {
        if (!currentOptionalHolidayDates.size) return false;
        
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dateStr = dateToString(currentDate);
            if (currentOptionalHolidayDates.has(dateStr)) {
                return true;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return false;
    }

    // Comprehensive validation function
    async function validateAllFields() {
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;
        const isHalfDay = halfDayToggle.checked;

        // Clear previous messages
        validationContainer.innerHTML = '';
        submitBtn.disabled = false;

        // Don't validate if fields are empty
        if (!startDateStr || !endDateStr || startDateStr === 'DD-MM-YYYY' || endDateStr === 'DD-MM-YYYY') {
            return;
        }

        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        if (!startDate || !endDate) {
            showError(' Invalid date format. Please use DD-MM-YYYY format.');
            return;
        }

        let hasErrors = false;

        // 1Ô∏è‚É£ Check if dates are in the past
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (startDate < today) {
            showError(' Cannot apply for leave in the past');
            hasErrors = true;
        }

        // 2Ô∏è‚É£ Check if end_date is before start_date
        if (endDate < startDate) {
            showError(' End date cannot be before start date');
            hasErrors = true;
        }

       // 3Ô∏è‚É£ Check for overlapping leaves
if (!hasErrors) {
    const isHalfDay = halfDayToggle.checked;
    const halfPeriod = firstHalfRadio.checked ? 'first_half' : (secondHalfRadio.checked ? 'second_half' : null);
    
    const overlapResult = checkForOverlappingLeaves(startDate, endDate, isHalfDay, halfPeriod);
    if (overlapResult.hasOverlap) {
        overlapResult.overlappingLeaves.forEach(leave => {
            const startFormatted = leave.start_date.toLocaleDateString('en-GB');
            const endFormatted = leave.end_date.toLocaleDateString('en-GB');
            const statusDisplay = leave.status === 'pending' ? 'Applied' : 'Approved';
            
            let leaveDesc = `${leave.leave_type_name} leave`;
            if (leave.is_half_day) {
                leaveDesc += ` (Half-day - ${leave.half_day_period === 'first_half' ? 'First Half' : 'Second Half'})`;
            }
            
            showError(`‚ùå Leave date conflict detected! Existing ${leaveDesc} from ${startFormatted} to ${endFormatted} (${statusDisplay})`);
        });
        
        hasErrors = true;
        submitBtn.disabled = true;
    }
}

        // 4Ô∏è‚É£ Calculate working days
        let workingDaysResult;
        if (isHalfDay) {
            workingDaysResult = { workingDays: 0.5, holidayCount: 0 };
        } else {
            workingDaysResult = calculateWorkingDays(startDate, endDate);
        }

        const workingDays = workingDaysResult.workingDays;
        const holidayCount = workingDaysResult.holidayCount;

        // 5Ô∏è‚É£ Check if there are any working days
        if (workingDays <= 0 && !isHalfDay) {
            showError(' No working days in selected range (all days are holidays/Sundays)');
            hasErrors = true;
        }

     // 6Ô∏è‚É£ Handle optional holidays display logic
const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
const leaveTypeName = selectedOption ? selectedOption.dataset.name || '' : '';
const isOptionalLeaveType = leaveTypeName.toLowerCase().includes('optional');
isOptionalLeaveTypeSelected = isOptionalLeaveType;

// Check if dates contain optional holidays
const hasOptionalHolidays = checkDatesForOptionalHolidays(startDate, endDate);
const isSingleDay = startDate.getTime() === endDate.getTime();

if (isOptionalLeaveType && !isHalfDay) {

    // üö´ STRICT RULE: Optional Leave = ONE DATE ONLY
    if (!isSingleDay) {
        showError('‚ùå Optional Leave can be applied for only ONE date.');
        submitBtn.disabled = true;

        optionalHolidaysSection.classList.remove('show');
        selectedOptionalHolidays = [];

        return; // ‚õî STOP everything here
    }

    // ‚úÖ SINGLE DAY OPTIONAL LEAVE
    optionalHolidaysSection.classList.remove('show');
    selectedOptionalHolidays = [];

    if (!hasOptionalHolidays) {
        showError('‚ùå Cannot use Optional Leave for selected date. Date must be an optional holiday.');
        submitBtn.disabled = true;
        hasErrors = true;
    } else {
        showInfo('‚úÖ Selected date is an optional holiday. This will be processed as Optional Leave.');
    }

} else if (!isOptionalLeaveType && !isHalfDay && hasOptionalHolidays) {

    // üü¢ OTHER LEAVE TYPES (Earned, Casual, etc.)
    let optionalCount = 0;
    let currentDate = new Date(startDate);

    while (currentDate <= endDate) {
        const dateStr = dateToString(currentDate);
        if (currentOptionalHolidayDates.has(dateStr)) {
            optionalCount++;
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }

    if (optionalCount > 0) {
        displayOptionalHolidays();
        optionalHolidaysSection.classList.add('show');
        showInfo(`‚ÑπÔ∏è ${optionalCount} optional holiday(s) available. You can choose to use Optional Leave for these days.`);
    } else {
        optionalHolidaysSection.classList.remove('show');
        selectedOptionalHolidays = [];
    }

} else {
    // Hide optional holidays section
    optionalHolidaysSection.classList.remove('show');
    selectedOptionalHolidays = [];
}


        // 7Ô∏è‚É£ Check advance notice (7 days for 3+ days, 15 days for 7+ days)
        if (!isHalfDay && !hasErrors) {
            const daysUntilStart = Math.floor((startDate - today) / (1000 * 60 * 60 * 24));
            
            if (workingDays >= 7 && daysUntilStart < 15) {
                showWarning(
                    ` Advance notice required: For ${workingDays} working days leave, ` +
                    `please apply at least 15 days in advance. ` +
                    `(Currently ${daysUntilStart} days in advance)`
                );
            } else if (workingDays >= 3 && workingDays < 7 && daysUntilStart < 7) {
                showWarning(
                    ` Advance notice required: For ${workingDays} working days leave, ` +
                    `please apply at least 7 days in advance. ` +
                    `(Currently ${daysUntilStart} days in advance)`
                );
            }
        }

        // Show holiday info
        if (holidayCount > 0 && !hasErrors && !isHalfDay) {
            showInfo(`‚ÑπÔ∏è ${holidayCount} holiday(s) excluded from working days calculation`);
        }

        // Disable submit if errors exist
        if (hasErrors) {
            submitBtn.disabled = true;
        }
    }

    // Helper functions to show messages
    function showError(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showWarning(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showInfo(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function showSuccess(message) {
        validationContainer.innerHTML += `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    async function calculateDaysAndFetchOptional() {
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;

        if (!startDateStr || !endDateStr || startDateStr === 'DD-MM-YYYY' || endDateStr === 'DD-MM-YYYY') {
            daysDisplay.textContent = '0 days';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        if (!startDate || !endDate || endDate < startDate) {
            daysDisplay.textContent = 'Invalid dates';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        // Check if half-day
        if (halfDayToggle.checked) {
            daysDisplay.innerHTML = '<span class="fw-bold text-primary">0.5 days</span>';
            document.getElementById('total_days').value = '0.5';
            document.getElementById('is_half_day').value = 'true';
            optionalHolidaysSection.classList.remove('show');
            return;
        }

        // Fetch optional holidays from backend
        try {
            const response = await fetch(
                `/leave/api/optional-holidays/?start_date=${dateToString(startDate)}&end_date=${dateToString(endDate)}`
            );
            const data = await response.json();

            if (data.success) {
                currentOptionalHolidays = data.optional_holidays;
                currentOptionalHolidayDates = new Set(currentOptionalHolidays.map(h => h.date));
                const workingDays = data.working_days;
                 // Check if it's single day or multiple days
                const isSingleDay = startDate.getTime() === endDate.getTime();

                // Show optional holidays section if:
                // 1. There are optional holidays in the range
                // 2. Leave type is NOT already "Optional Leave"
                const leaveTypeName = leaveTypeSelect.options[leaveTypeSelect.selectedIndex]?.dataset.name || '';
                const isOptionalLeaveType = leaveTypeName.toLowerCase().includes('optional');
                isOptionalLeaveTypeSelected = isOptionalLeaveType;

                if (currentOptionalHolidays.length > 0 && !isOptionalLeaveType|| !isSingleDay) {
                    displayOptionalHolidays();
                    optionalHolidaysSection.classList.add('show');
                } else {
                    optionalHolidaysSection.classList.remove('show');
                    selectedOptionalHolidays = [];
                }

                updateDaysDisplay(workingDays, data.mandatory_holidays_count);
                
                // Trigger validation after fetching optional holidays
                validateAllFields();
            }
        } catch (error) {
            console.error('Error fetching optional holidays:', error);
        }
    }

    function displayOptionalHolidays() {
        optionalHolidaysList.innerHTML = '';

        currentOptionalHolidays.forEach(holiday => {
            const isSelected = selectedOptionalHolidays.includes(holiday.date);
            const holidayDate = new Date(holiday.date);
            const formattedDate = holidayDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });

            const itemDiv = document.createElement('div');
            itemDiv.className = `optional-holiday-item ${isSelected ? 'selected' : ''}`;
            itemDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <input type="checkbox" 
                           name="optional_holidays" 
                           value="${holiday.date}" 
                           class="optional-holiday-checkbox me-3"
                           ${isSelected ? 'checked' : ''}
                           id="opt_${holiday.date}">
                    <label for="opt_${holiday.date}" class="flex-grow-1 mb-0" style="cursor: pointer;">
                        <strong>${holiday.name}</strong>
                        <span class="holiday-info-badge">${formattedDate}</span>
                        <br>
                        <small class="text-muted">${holiday.region}</small>
                    </label>
                </div>
            `;

            itemDiv.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = itemDiv.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            const checkbox = itemDiv.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    itemDiv.classList.add('selected');
                    if (!selectedOptionalHolidays.includes(holiday.date)) {
                        selectedOptionalHolidays.push(holiday.date);
                    }
                } else {
                    itemDiv.classList.remove('selected');
                    selectedOptionalHolidays = selectedOptionalHolidays.filter(d => d !== holiday.date);
                }
                updateDaysDisplayWithOptional();
            });

            optionalHolidaysList.appendChild(itemDiv);
        });
    }

    function updateDaysDisplay(workingDays, mandatoryCount) {
        document.getElementById('total_days').value = workingDays.toString();
        document.getElementById('is_half_day').value = 'false';

        daysDisplay.innerHTML = `<span class="fw-bold">${workingDays} days</span>`;
        if (mandatoryCount > 0) {
            daysDisplay.innerHTML += `<small class="text-muted d-block">${mandatoryCount} mandatory holiday(s) excluded</small>`;
        }
    }

    function updateDaysDisplayWithOptional() {
    const totalDaysInput = document.getElementById('total_days');
    const currentWorkingDays = parseFloat(totalDaysInput.value) || 0;
    const optionalCount = selectedOptionalHolidays.length;

    const selectedLeaveText =
        leaveTypeSelect.options[leaveTypeSelect.selectedIndex]?.text || '';

    const isOptionalLeave =
        selectedLeaveText.toLowerCase().includes('optional');

    daysDisplay.innerHTML = '';

    // üîπ CASE 1: Optional Leave selected
    if (isOptionalLeave) {
        daysDisplay.innerHTML = `
            <span class="fw-bold">${optionalCount} days</span>
            <br><small class="text-success">‚úì Optional Leave</small>
        `;
        return;
    }

    // üîπ CASE 2: Other leave types
    const adjustedDays = Math.max(currentWorkingDays - optionalCount, 0);

    daysDisplay.innerHTML = `<span class="fw-bold">${adjustedDays} days</span>`;

    if (optionalCount > 0) {
        daysDisplay.innerHTML += `
            <br><small class="text-success">‚úì Using ${optionalCount} optional holiday(s)</small>
            <br><small class="text-muted">
                ${adjustedDays} from ${selectedLeaveText},
                ${optionalCount} from Optional Leave
            </small>
        `;
    }
}


    // Update balance display
    leaveTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const leaveTypeName = selectedOption ? selectedOption.dataset.name || '' : '';
        isOptionalLeaveTypeSelected = leaveTypeName.toLowerCase().includes('optional');
        
        if (selectedType && leaveBalances[selectedType]) {
            const balance = leaveBalances[selectedType];
            let infoHtml = '';
            
            // if (balance.is_optional) {
            //     const remainingUsable = Math.max(0, 2 - balance.taken);
            //     infoHtml = `<span class="text-info">Max usable: ${remainingUsable} days remaining</span>`;
            // }
            
            if (!balance.can_use_same_month) {
                infoHtml += `<br><span class="text-warning">Cannot use in same month as accrual</span>`;
            }
            
            balanceDisplay.innerHTML = `
                <span class="text-success fw-bold">${balance.remaining} days available</span>
                <small class="d-block text-muted">(Total: ${balance.total}, Taken: ${balance.taken})</small>
                ${infoHtml}
            `;
            
            leaveTypeInfo.innerHTML = infoHtml;
            
            // If Optional Leave type is selected, show warning
            if (isOptionalLeaveTypeSelected) {
                const startDateStr = startDateInput.value;
                const endDateStr = endDateInput.value;
                
                if (startDateStr && endDateStr && startDateStr !== 'DD-MM-YYYY' && endDateStr !== 'DD-MM-YYYY') {
                    showInfo('‚ö†Ô∏è Note: Optional Leave type can only be used for dates that are optional holidays.');
                }
            }
            
            // Hide optional holidays section if Optional Leave type is selected
            if (isOptionalLeaveTypeSelected) {
                optionalHolidaysSection.classList.remove('show');
                selectedOptionalHolidays = [];
            }
        } else {
            balanceDisplay.textContent = 'Select a leave type to see balance';
            leaveTypeInfo.innerHTML = '';
        }
        
        validateAllFields();
    });

    // Half day toggle
    halfDayToggle.addEventListener('change', function() {
        if (this.checked) {
            halfOptions.classList.add('active');
            
            if (startDateInput.value && startDateInput.value !== 'DD-MM-YYYY') {
                endDateInput.value = startDateInput.value;
                const startDate = parseDate(startDateInput.value);
                if (startDate) {
                    $(endDateInput).datepicker('setDate', startDate);
                    $(endDateInput).datepicker('update');
                }
            }
            
            endDateInput.disabled = true;
            endDateInput.readOnly = true;
            $(endDateInput).datepicker('disable');
            
            calculateDaysAndFetchOptional();
            validateAllFields();
        } else {
            halfOptions.classList.remove('active');
            firstHalfRadio.checked = false;
            secondHalfRadio.checked = false;
            firstHalfLabel.classList.remove('selected');
            secondHalfLabel.classList.remove('selected');
            
            endDateInput.disabled = false;
            endDateInput.readOnly = false;
            $(endDateInput).datepicker('enable');
            
            calculateDaysAndFetchOptional();
            validateAllFields();
        }
    });

    // Half day option selection
    firstHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            firstHalfLabel.classList.add('selected');
            secondHalfLabel.classList.remove('selected');
        }
    });

    secondHalfRadio.addEventListener('change', function() {
        if (this.checked) {
            secondHalfLabel.classList.add('selected');
            firstHalfLabel.classList.remove('selected');
        }
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', async function(e) {
        const totalDays = document.getElementById('total_days').value;
        const startDateStr = startDateInput.value;
        const endDateStr = endDateInput.value;
        const leaveTypeId = leaveTypeSelect.value;
        const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
        const leaveTypeName = selectedOption ? selectedOption.dataset.name || '' : '';
        const isOptionalLeaveType = leaveTypeName.toLowerCase().includes('optional');
        
        // Final validation before submission
        if (halfDayToggle.checked) {
            if (!firstHalfRadio.checked && !secondHalfRadio.checked) {
                e.preventDefault();
                alert('Please select either First Half or Second Half for half-day leave.');
                return false;
            }
            if (parseFloat(totalDays) <= 0) {
                e.preventDefault();
                alert('Please select valid dates.');
                return false;
            }
        }
        
        // Validate Optional Leave type selection
if (isOptionalLeaveType && startDateStr && endDateStr) {
    const startDate = parseDate(startDateStr);
    const endDate = parseDate(endDateStr);
    
    if (startDate && endDate) {
        const isSingleDay = startDate.getTime() === endDate.getTime();
        const hasOptionalHolidays = checkDatesForOptionalHolidays(startDate, endDate);
        
        if (isSingleDay) {
            // Single day must be optional holiday
            if (!hasOptionalHolidays) {
                e.preventDefault();
                alert('‚ùå Half-day leave can not be applied under Optional leave type');
                return false;
            }
        } else {
            // Multiple days must contain at least one optional holiday
            if (!hasOptionalHolidays) {
                e.preventDefault();
                alert('‚ùå Cannot use Optional Leave for selected dates. The date range does not contain any optional holidays.');
                return false;
            }
            
            // For multiple days, auto-select all optional holidays
            // Ensure optional holidays are selected
            if (selectedOptionalHolidays.length === 0) {
                // Auto-select all optional holidays
                let optionalDates = [];
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dateStr = dateToString(currentDate);
                    if (currentOptionalHolidayDates.has(dateStr)) {
                        optionalDates.push(dateStr);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                selectedOptionalHolidays = optionalDates;
            }
        }
    }
}
        
        // Final overlap check on submission
if (startDateStr && endDateStr) {
    const startDate = parseDate(startDateStr);
    const endDate = parseDate(endDateStr);
    const isHalfDay = halfDayToggle.checked;
    const halfPeriod = firstHalfRadio.checked ? 'first_half' : (secondHalfRadio.checked ? 'second_half' : null);
    
    if (startDate && endDate) {
        const overlapResult = checkForOverlappingLeaves(startDate, endDate, isHalfDay, halfPeriod);
        if (overlapResult.hasOverlap) {
            e.preventDefault();
            
            let alertMessage = `‚ùå Leave date conflict detected:\n\n`;
            overlapResult.overlappingLeaves.forEach(leave => {
                const startFormatted = leave.start_date.toLocaleDateString('en-GB');
                const endFormatted = leave.end_date.toLocaleDateString('en-GB');
                const statusDisplay = leave.status === 'pending' ? 'Applied' : 'Approved';
                
                let leaveDesc = `${leave.leave_type_name} leave`;
                if (leave.is_half_day) {
                    leaveDesc += ` (Half-day - ${leave.half_day_period === 'first_half' ? 'First Half' : 'Second Half'})`;
                }
                
                alertMessage += `‚Ä¢ ${leaveDesc}: ${startFormatted} to ${endFormatted} (${statusDisplay})\n`;
            });
            alertMessage += `\nPlease select different dates.`;
            
            alert(alertMessage);
            return false;
        }
    }
}
        
        // Check if there are any validation errors
        const errorAlerts = validationContainer.querySelectorAll('.alert-danger');
        if (errorAlerts.length > 0) {
            e.preventDefault();
            alert('Please fix the validation errors before submitting.');
            return false;
        }
    });

    // Fetch existing leaves when page loads
    fetchExistingLeaves();
});
</script>
{% endblock %}