{% extends 'base.html' %}
{% load static %}

{% block title %}Salary Components - HRMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h3 mb-0">Salary Components</h1>
                <p class="text-muted mb-0">Manage salary components and allowances</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addComponentModal">
                    <i class="fas fa-plus me-2"></i>Add Component
                </button>
            </div>
        </div>
    </div>

    <!-- Components Grid -->
    <div class="row">
        {% for component in components %}
        <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
            <div class="custom-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ component.name }}</h5>
                    <span class="badge {% if component.component_type == 'earning' %}bg-success{% else %}bg-danger{% endif %}">
                        {{ component.get_component_type_display }}
                    </span>
                </div>
                
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Calculation Type</small>
                            <div class="fw-bold">{{ component.get_calculation_type_display }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Value</small>
                            <div class="fw-bold">
                                {% if component.calculation_type == 'percentage' %}
                                    {{ component.value }}%
                                {% else %}
                                    â‚¹{{ component.value }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if component.formula %}
                    <div class="mb-3">
                        <small class="text-muted">Formula</small>
                        <div class="fw-bold text-truncate">{{ component.formula }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Taxable</small>
                            <div class="fw-bold">
                                {% if component.is_taxable %}
                                <span class="text-success">Yes</span>
                                {% else %}
                                <span class="text-danger">No</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status</small>
                            <div class="fw-bold">
                                {% if component.is_active %}
                                <span class="text-success">Active</span>
                                {% else %}
                                <span class="text-danger">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <button class="btn btn-outline-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editComponentModal{{ component.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form method="post" action="{% url 'toggle_salary_component' component.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-{% if component.is_active %}warning{% else %}success{% endif %} btn-sm">
                                <i class="fas fa-{% if component.is_active %}pause{% else %}play{% endif %}"></i>
                            </button>
                        </form>
                        <form method="post" action="{% url 'delete_salary_component' component.id %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this component?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Component Modal -->
        <div class="modal fade" id="editComponentModal{{ component.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Salary Component</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" action="{% url 'edit_salary_component' component.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Component Name</label>
                                <input type="text" class="form-control" name="name" value="{{ component.name }}" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Component Type</label>
                                    <select class="form-select" name="component_type" required>
                                        <option value="earning" {% if component.component_type == 'earning' %}selected{% endif %}>Earning</option>
                                        <option value="deduction" {% if component.component_type == 'deduction' %}selected{% endif %}>Deduction</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Calculation Type</label>
                                    <select class="form-select" name="calculation_type" id="calcType{{ component.id }}" required>
                                        <option value="fixed" {% if component.calculation_type == 'fixed' %}selected{% endif %}>Fixed Amount</option>
                                        <option value="percentage" {% if component.calculation_type == 'percentage' %}selected{% endif %}>Percentage</option>
                                        <option value="formula" {% if component.calculation_type == 'formula' %}selected{% endif %}>Formula Based</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Value</label>
                                <input type="number" class="form-control" name="value" value="{{ component.value }}" step="0.01" required>
                            </div>
                            <div class="mb-3" id="formulaField{{ component.id }}" style="display: {% if component.calculation_type == 'formula' %}block{% else %}none{% endif %};">
                                <label class="form-label">Formula</label>
                                <input type="text" class="form-control" name="formula" value="{{ component.formula|default:'' }}" placeholder="e.g., basic_salary * 0.4">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_taxable" id="taxable{{ component.id }}" {% if component.is_taxable %}checked{% endif %}>
                                    <label class="form-check-label" for="taxable{{ component.id }}">
                                        Is Taxable
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Component</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="custom-card text-center py-5">
                <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Salary Components</h4>
                <p class="text-muted">Get started by creating your first salary component.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addComponentModal">
                    <i class="fas fa-plus me-2"></i>Add First Component
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Salary Component</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'add_salary_component' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Component Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., House Rent Allowance" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Component Type</label>
                            <select class="form-select" name="component_type" required>
                                <option value="">Select Type</option>
                                <option value="earning">Earning</option>
                                <option value="deduction">Deduction</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Calculation Type</label>
                            <select class="form-select" name="calculation_type" id="calcType" required>
                                <option value="">Select Type</option>
                                <option value="fixed">Fixed Amount</option>
                                <option value="percentage">Percentage</option>
                                <option value="formula">Formula Based</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value</label>
                        <input type="number" class="form-control" name="value" value="0" step="0.01" required>
                    </div>
                    <div class="mb-3" id="formulaField" style="display: none;">
                        <label class="form-label">Formula</label>
                        <input type="text" class="form-control" name="formula" placeholder="e.g., basic_salary * 0.4">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_taxable" id="taxable" checked>
                            <label class="form-check-label" for="taxable">
                                Is Taxable
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Component</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show/hide formula field based on calculation type
    document.getElementById('calcType').addEventListener('change', function() {
        document.getElementById('formulaField').style.display = 
            this.value === 'formula' ? 'block' : 'none';
    });

    // For edit modals
    document.querySelectorAll('[id^="calcType"]').forEach(select => {
        select.addEventListener('change', function() {
            const modalId = this.id.replace('calcType', '');
            document.getElementById('formulaField' + modalId).style.display = 
                this.value === 'formula' ? 'block' : 'none';
        });
    });
</script>
{% endblock %}