{% extends 'base.html' %}
{% load static %}

{% block title %}Employee Dashboard - HR System{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --info: #4895ef;
        --warning: #f72585;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --white: #ffffff;
    }

    .dashboard-container {
        background-color: #f5f7fb;
        min-height: calc(100vh - 70px);
        padding: 20px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--white);
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
    }

    .dashboard-header h1 {
        font-size: 1.8rem;
        color: var(--primary);
        font-weight: 600;
        margin: 0;
    }

    .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .dashboard-card {
        background-color: var(--white);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
        border: none;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
    }

    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: none;
        background: transparent;
        padding: 0;
    }

    .card-header-custom h3 {
        font-size: 1rem;
        color: var(--gray);
        font-weight: 500;
        margin: 0;
    }

    .card-header-custom i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .card-body-custom h2 {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .card-body-custom p {
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 5px;
        margin-bottom: 0;
    }

    /* Modern Information Section */
    .modern-info-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .info-card {
        background-color: var(--white);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: none;
    }

    .info-header {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 20px;
        margin-bottom: 25px;
    }

    .info-header h3 {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f5f5f5;
    }

    .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .info-label {
        font-size: 0.85rem;
        color: var(--gray);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .info-value {
        font-size: 1.1rem;
        color: var(--dark);
        font-weight: 500;
    }

    .profile-main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 30px;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .profile-main::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(30deg);
    }

    .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        position: relative;
        z-index: 2;
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .profile-avatar i {
        font-size: 2.5rem;
        color: white;
    }

    .profile-info h2 {
        font-size: 1.8rem;
        font-weight: 600;
        margin: 0 0 5px 0;
    }

    .profile-info .designation {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }

    .profile-details {
        position: relative;
        z-index: 2;
    }

    .profile-details .info-item {
        border-bottom-color: rgba(255, 255, 255, 0.2);
    }

    .profile-details .info-label {
        color: rgba(255, 255, 255, 0.8);
    }

    .profile-details .info-value {
        color: white;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    .status-badge i {
        margin-right: 8px;
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }

    .chart-container {
        background-color: var(--white);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: none;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .chart-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .chart-body {
        height: 300px;
        position: relative;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .action-card {
        background-color: var(--white);
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: transform 0.3s;
        border: none;
    }

    .action-card:hover {
        transform: translateY(-5px);
    }

    .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        color: white;
        font-size: 1.5rem;
    }

    /* Custom Card Styles */
    .custom-card {
        background-color: var(--white);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        border: none;
    }

    .custom-card .card-header {
        border-radius: 10px 10px 0 0;
        padding: 15px 20px;
    }

    .custom-card .card-body {
        padding: 20px;
    }

    /* Responsive Design */
    @media (max-width: 992px) {

        .charts-section,
        .modern-info-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {

        .dashboard-cards,
        .quick-actions {
            grid-template-columns: 1fr;
        }

        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .btn-toolbar {
            margin-top: 15px;
        }

        .profile-header {
            flex-direction: column;
            text-align: center;
        }

        .profile-avatar {
            margin-right: 0;
            margin-bottom: 15px;
        }
         .attendance-card .d-flex {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px;
    }

    #attendanceTopInfo {
        width: 100%;
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        flex-wrap: wrap;
    }

    #attendanceTopInfo .badge {
        font-size: 0.85rem;
        padding: 6px 10px;
    }

    #workDuration {
        padding: 6px 10px !important;
        font-size: 0.85rem !important;
    }
    }

    /* âœ… Professional Attendance Card */
    .attendance-card {
        background: #ffffff;
        border-radius: 18px;        
        padding: 25px 30px;
        transition: all 0.3s ease-in-out;
        margin-bottom: 23px;
    }

    .attendance-card:hover {
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.06);
    }

    /* Subtle borders for tiles */
    .attendance-tile {
        background-color: #fafafa;
        transition: all 0.3s ease;
    }

    .attendance-tile:hover {
        background-color: #f8f9fa;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }

    /* Light gradient for header badge */
    .badge.bg-light.text-dark {
        background: linear-gradient(to right, #f8fafc, #f1f5f9);
        border: 1px solid #e2e8f0;
    }

    /* On-Time and Late badges */
    .bg-success-subtle {
        background-color: #e8f5e9 !important;
    }

    .bg-warning-subtle {
        background-color: #fff8e1 !important;
    }

    /* Icons */
    .icon {
        width: 60px;
        height: 60px;
    }

    /* Buttons hover */
    .btn-success:hover {
        background-color: #198754 !important;
        transform: translateY(-2px);
    }

    .btn-danger:hover {
        background-color: #bb2d3b !important;
        transform: translateY(-2px);
    }

    /* Responsive behavior */
    @media (max-width: 768px) {
        .attendance-tile {
            margin-bottom: 15px;
        }
    }
    /* ðŸ”” Notification Bell */
.notification-bell {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #4361ee;
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    cursor: pointer;
    transition: transform 0.3s ease;
    z-index: 1050;
}

.notification-bell:hover {
    transform: scale(1.1);
}

.notification-bell .badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f72585;
    color: white;
    font-size: 0.75rem;
    padding: 3px 6px;
    border-radius: 50%;
}

/* ðŸ”” Notification Popup */
.notification-popup {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 380px;
    max-height: 500px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    overflow-y: auto;
    overflow-x: hidden; /* âœ… prevents horizontal scroll */
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1051;
    word-wrap: break-word; /* âœ… breaks long text */
    overflow-wrap: break-word;
}

.notification-popup.show {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

.notification-popup-header {
    background: linear-gradient(135deg, #4361ee, #4895ef);
    color: white;
    padding: 15px 20px;
    border-radius: 15px 15px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.notification-popup-header h5 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.notification-popup-body {
    padding: 15px 20px;
}

/* âœ… Fix message wrapping */
.notification-item {
    display: flex;
    align-items: flex-start;
    border-bottom: 1px solid #f1f1f1;
    padding: 12px 0;
    transition: background-color 0.2s ease;
    flex-wrap: wrap; /* âœ… allows text to wrap to next line */
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1rem;
}

.notification-icon.warning {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.notification-icon.appreciation {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.notification-content {
    flex: 1;
    min-width: 0; /* âœ… ensures wrapping inside flexbox */
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* âœ… forces text to wrap downwards */
}

.notification-content h6 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #212529;
}

.notification-content p {
    margin: 5px 0 8px;
    font-size: 0.85rem;
    color: #555;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* âœ… ensures no sideways scroll */
}

.notification-meta {
    font-size: 0.8rem;
    color: #888;
    flex-wrap: wrap;
}

.notification-empty {
    text-align: center;
    padding: 30px 10px;
    color: #999;
}

.notification-empty i {
    font-size: 2rem;
    margin-bottom: 10px;
}

/* âœ… Responsive for mobile */
@media (max-width: 768px) {
    .notification-popup {
        width: 90%;
        right: 5%;
        bottom: 80px;
        max-height: 70vh;
    }

    .notification-item {
        flex-direction: column;
    }

    .notification-icon {
        margin-right: 0;
        margin-bottom: 10px;
    }
}


</style>

<div class="dashboard-container">
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Welcome {{ employee.first_name }}</h3>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <span class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-calendar"></i> {{ today_date|date:"M d, Y" }}
                </span>
            </div>
        </div>
    </div>


    {% if employee %}
    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
        <!-- <div class="dashboard-card">
            <div class="card-header-custom">
                <h3>Days Worked</h3>
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="card-body-custom">
                <h2>
                    {% if employee.date_of_joining %}
                        {{ employee.date_of_joining|timesince:today_date }}
                    {% else %}
                        N/A
                    {% endif %}
                </h2>
                <p>Since joining</p>
            </div>
        </div> -->
        <div class="dashboard-card">
            <div class="card-header-custom">
                <h3>Total Team Members</h3>
                <i class="fas fa-users"></i>
            </div>
            <div class="card-body-custom">
                {% if total_team_members %}
                <h2>{{ total_team_members }}</h2>
                <p>
                    <a href="{% url 'total_team_members' %}" style="color: inherit; text-decoration: none;">
                        Active Team Members
                    </a>
                </p>
                {% else %}
                <h2>-</h2>
                <p>Department not assigned</p>
                {% endif %}
            </div>
        </div>


        <div class="dashboard-card">
            <div class="card-header-custom">
                <h3>Leaves Available</h3>
                <i class="fas fa-umbrella-beach"></i>
            </div>
            <div class="card-body-custom">
                <h2>{{ total_remaining_leaves }}</h2>
                <p> <a href="{% url 'employee_leave_details' %}" style="color: inherit; text-decoration: none;">
                        Remaining this year
                    </a></p>
            </div>
        </div>
        <div class="dashboard-card">
            <div class="card-header-custom">
                <h3>Upcoming Holidays</h3>
                <i class="fas fa-glass-cheers"></i>
            </div>
            <div class="card-body-custom">
                <h2>{{ upcoming_holidays }}</h2>
                <p>In next 30 days</p>
            </div>
        </div>

    </div>


    <!-- Charts Section -->
    <!-- <div class="charts-section">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Monthly Attendance Overview</h3>
            </div>
            <div class="chart-body">
                <canvas id="workHoursChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-header">
                <h3>Leave Details</h3>
            </div>
            <div class="chart-body">
                <canvas id="taskChart"></canvas>
            </div>
        </div>
    </div> -->


 <!-- âœ… Attendance Section -->
    <div class="attendance-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-primary fw-bold mb-0"><i class="fas fa-user-clock me-2"></i>Todayâ€™s Attendance</h5>
            <div id="attendanceTopInfo" class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark border">
                    {% if today_attendance %}
                        {{ today_attendance.date|date:"D, M d, Y" }}
                    {% else %}
                        Today
                    {% endif %}
                </span>

                {% if today_attendance and today_attendance.check_in and not today_attendance.check_out %}
                    <span id="workDuration"
                        class="badge bg-primary text-white"
                        data-checkin="{{ today_attendance.check_in|date:'Y-m-d H:i:s' }}"
                        data-checkedout="false">
                    </span>
                {% endif %}
            </div>
        </div>

        {% if today_attendance %}
        <div class="row g-3 text-center">
            <div class="col-md-6">
                <div class="attendance-tile">
                    <i class="fas fa-sign-in-alt text-success fs-3 mb-2"></i>
                    <h6 class="text-muted mb-1">Check-In</h6>
                    <h4 class="fw-bold text-success">{{ today_attendance.check_in|date:"h:i A" }}</h4>

                    {% if punctuality_status %}
                        <span class="badge {% if punctuality_status == 'Late' %}bg-danger-subtle text-danger{% else %}bg-success-subtle text-success{% endif %} px-3 py-2 rounded-pill">
                            {{ punctuality_status }}
                        </span>
                    {% endif %}

                    {% if today_attendance.checkin_address %}
                    <p class="text-muted small mt-2">
                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                        {{ today_attendance.checkin_address }}
                        <a href="https://www.google.com/maps?q={{ today_attendance.checkin_latitude }},{{ today_attendance.checkin_longitude }}" target="_blank" class="text-primary small">(View Map)</a>
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-6">
                <div class="attendance-tile">
                    <i class="fas fa-sign-out-alt text-danger fs-3 mb-2"></i>
                    <h6 class="text-muted mb-1">Check-Out</h6>
                    <h4 class="fw-bold text-danger">
                        {% if today_attendance.check_out %}
                        {{ today_attendance.check_out|date:"h:i A" }}
                        {% else %}
                        Not Yet
                        {% endif %}
                    </h4>

                    {% if today_attendance.checkout_address %}
                    <p class="text-muted small mt-2">
                        <i class="fas fa-map-marker-alt text-success me-1"></i>
                        {{ today_attendance.checkout_address }}
                        <a href="https://www.google.com/maps?q={{ today_attendance.checkout_latitude }},{{ today_attendance.checkout_longitude }}" target="_blank" class="text-primary small">(View Map)</a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <p class="text-secondary mb-1 fw-semibold">No attendance marked yet</p>
            <small class="text-muted">Click below to mark your check-in for today.</small>
        </div>
        {% endif %}

        <div class="text-center mt-4">
            <form method="POST" id="attendanceForm">
                {% csrf_token %}
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">
                <input type="hidden" name="address" id="address">

                {% if not today_attendance %}
                <button type="submit" name="action" value="check_in" class="btn btn-success px-4 py-2 rounded-pill">
                    <i class="fas fa-sign-in-alt me-2"></i> Check In
                </button>
                {% elif not today_attendance.check_out %}
                <button type="submit" name="action" value="check_out" class="btn btn-danger px-4 py-2 rounded-pill">
                    <i class="fas fa-sign-out-alt me-2"></i> Check Out
                </button>
                {% else %}
                <button type="button" class="btn btn-secondary px-4 py-2 rounded-pill" disabled>
                    <i class="fas fa-check-circle me-2"></i> Attendance Complete
                </button>
                {% endif %}
            </form>
        </div>
    </div>
    <!-- âœ… Live Map & Location Script -->


    <!-- Modern Information Section -->
    <div class="modern-info-section">
        <!-- Personal Information Card -->
        <div class="info-card">
            <div class="info-header">
                <h3>Personal Information</h3>
            </div>
            <div class="info-content">
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ employee.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Phone</div>
                    <div class="info-value">{{ employee.phone|default:"Not specified" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Reporting Manager</div>
                    <div class="info-value">{{ employee.reporting_manager|default:"Not assigned" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Date of Joining</div>
                    <div class="info-value">{{ employee.date_of_joining|date:"d M, Y"|default:"Not available" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Date of Birth</div>
                    <div class="info-value">
                        {% if employee.date_of_birth and employee.date_of_birth %}
                        {{ employee.date_of_birth }}
                        {% else %}
                        Not specified
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Main Card -->
        <div class="profile-main">
            <div class="profile-header">
                <div class="profile-avatar">
                    {% if employee.profile_picture %}
                    <img src="{{ employee.profile_picture.url }}" alt="Profile"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <div class="profile-info">
                    <h2>{{ employee.first_name }} {{ employee.last_name }}</h2>
                    <p style="color: white;" class="designation">{{ employee.designation }}</p>
                </div>
            </div>
            <div class="profile-details">
                <div class="info-item">
                    <div class="info-label">Employee ID</div>
                    <div class="info-value">{{ employee.employee_id }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Department</div>
                    <div class="info-value">{{ employee.department }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Location</div>
                    <div class="info-value">{{ employee.location|default:"Not specified" }}</div>
                </div>
                <div class="status-badge">
                    {% if employee.status == 'active' %}
                    <i class="fas fa-check-circle"></i> Active
                    {% else %}
                    <i class="fas fa-exclamation-circle"></i> Inactive
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Employment Details -->


    <!-- Status-based Alert -->
    {% if employee.status != 'active' %}
    <div class="row mt-3">
        <div class="col-12">
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="alert-heading mb-1">Account Inactive</h5>
                        <p class="mb-0">Your account is currently inactive. Self-service features like profile updates
                            and password changes are disabled. Please contact your HR department to activate your
                            account.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="custom-card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 4rem;"></i>
                    <h3>Profile Not Found</h3>
                    <p class="text-muted">Your employee profile could not be found in the system.</p>
                    <p class="text-muted">Please contact your HR department to set up your employee profile.</p>
                    <div class="mt-4">
                        <p><strong>Your login email:</strong> {{ request.session.user_email }}</p>
                    </div>
                    <div class="mt-3">
                        <a href="mailto:hr@yourcompany.com" class="btn btn-primary">
                            <i class="fas fa-envelope"></i> Contact HR
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<!-- ðŸ”´ðŸŸ¢ Notifications Section - Warnings & Appreciations -->

<!-- âœ… Notification Bell Icon -->
<div class="notification-bell" id="notificationBell">
    <i class="fas fa-bell"></i>
    {% if notifications_count > 0 %}
    <span class="badge">{{ notifications_count }}</span>
    {% endif %}
</div>


<!-- âœ… Notification Popup (Hidden by Default) -->
<div class="notification-popup" id="notificationPopup">
    <div class="notification-popup-header">
        <h5><i class="fas fa-bell me-2"></i>Recent Notifications</h5>
        <i class="fas fa-times" id="closeNotification" style="cursor:pointer;"></i>
    </div>
    <div class="notification-popup-body">
        {% if recent_warnings_count == 0 and recent_appreciations_count == 0 %}
        <!-- Show empty message -->
        <div class="notification-empty">
            <i class="fas fa-smile text-success"></i>
            <p>No new notifications in the last 7 days ðŸŽ‰</p>
        </div>
        {% else %}
        <!-- Show warnings -->
        {% for n in notifications %}
        <div class="notification-item">
            <div class="notification-icon 
        {% if n.message_category == 'Warning' %}
            warning
        {% else %}
            appreciation
        {% endif %}">

                {% if n.message_category == 'Warning' %}
                <i class="fas fa-exclamation-circle"></i>
                {% else %}
                <i class="fas fa-award"></i>
                {% endif %}
            </div>

            <div class="notification-content">
                <h6>{{ n.subject }}</h6>
                <p>{{ n.description|default:"No details provided." }}</p>

                <div class="notification-meta">
                    <i class="fas fa-user-tie me-1"></i>{{ n.issued_by }} Â·
                    <i class="far fa-calendar-alt ms-2 me-1"></i>{{ n.warning_date|date:"M d, Y" }}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Show appreciations -->
        {% for appr in recent_appreciations %}
        <div class="notification-item">
            <div class="notification-icon appreciation"><i class="fas fa-award"></i></div>
            <div class="notification-content">
                <h6>{{ appr.subject }}</h6>
                <p>{{ appr.description|default:"No details provided." }}</p>
                <div class="notification-meta">
                    <i class="fas fa-user-tie me-1"></i>{{ appr.issued_by }} &middot;
                    <i class="far fa-calendar-alt ms-2 me-1"></i>{{ appr.warning_date|date:"M d, Y" }}
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- âœ… JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const bell = document.getElementById("notificationBell");
        const popup = document.getElementById("notificationPopup");
        const closeBtn = document.getElementById("closeNotification");

        // Toggle popup when bell clicked
        bell.addEventListener("click", () => {
            popup.classList.toggle("show");
        });

        // Close popup when "x" clicked
        closeBtn.addEventListener("click", () => {
            popup.classList.remove("show");
        });

        // Close popup when clicking outside
        document.addEventListener("click", (e) => {
            if (!popup.contains(e.target) && !bell.contains(e.target)) {
                popup.classList.remove("show");
            }
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const mapContainer = document.createElement("div");
    mapContainer.id = "liveMap";
    mapContainer.style.width = "100%";
    mapContainer.style.height = "300px";
    mapContainer.style.borderRadius = "10px";
    mapContainer.style.marginTop = "20px";
    mapContainer.style.display = "none";
    document.querySelector(".attendance-card").appendChild(mapContainer);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
    } else {
        alert("Geolocation not supported in this browser.");
    }

    function successCallback(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // Fill hidden inputs for Django form
        const latInput = document.getElementById("latitude");
        const lonInput = document.getElementById("longitude");
        const addrInput = document.getElementById("address");
        if (latInput && lonInput) {
            latInput.value = lat;
            lonInput.value = lon;
        }

        // âœ… Reverse-geocode to get simplified city + state
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
            .then(res => res.json())
            .then(data => {
                let city = data.address.city || data.address.town || data.address.village || "";
                let state = data.address.state || "";
                let country = data.address.country || "";

                // âœ… Create simplified address (City, State, Country)
                let addressName = "";
                if (city && state) {
                    addressName = `${city}, ${state}, ${country}`;
                } else if (state) {
                    addressName = `${state}, ${country}`;
                } else {
                    addressName = data.display_name || "Current location";
                }

                if (addrInput) addrInput.value = addressName;

                // Show map preview
                showMap(lat, lon, addressName);
            })
            .catch(() => {
                if (addrInput) addrInput.value = "Address not found";
            });
    }

    function errorCallback(err) {
        console.error("Geolocation error:", err);
    }

    function showMap(lat, lon, label) {
        mapContainer.style.display = "block";
        mapContainer.innerHTML = ""; // clear previous map

        // Include Leaflet map library
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "https://unpkg.com/leaflet/dist/leaflet.css";
        document.head.appendChild(link);
        const script = document.createElement("script");
        script.src = "https://unpkg.com/leaflet/dist/leaflet.js";
        script.onload = function () {
            const map = L.map("liveMap").setView([lat, lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
            }).addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup(label).openPopup();

            // Hide map after 60 seconds
            setTimeout(() => {
                mapContainer.style.display = "none";
                map.remove();
            }, 60000);
        };
        document.body.appendChild(script);
    }
});
</script>
<script>
    // Month-wise attendance labels
    const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Static days attended for each month
    const monthData = [22, 18, 20, 21, 19, 23, 20, 22, 21, 18, 20, 22];

    // Work Hours Chart (Bar)
    const workHoursCtx = document.getElementById('workHoursChart').getContext('2d');
    const workHoursChart = new Chart(workHoursCtx, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Days Attended',
                data: monthData,
                backgroundColor: monthLabels.map((_, i) =>
                    i % 2 === 0 ? 'rgba(67, 97, 238, 0.8)' : 'rgba(63, 55, 201, 0.8)'
                ),
                borderColor: monthLabels.map((_, i) =>
                    i % 2 === 0 ? 'rgba(67, 97, 238, 1)' : 'rgba(63, 55, 201, 1)'
                ),
                borderWidth: 1,
                barPercentage: 0.5,
                categoryPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return `${context.label}: ${context.parsed.y} days present`;
                        }
                    }
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 31,
                    ticks: { stepSize: 5 },
                    title: { display: true, text: 'Days Worked' }
                },
                x: {
                    title: { display: true, text: 'Month' },
                    grid: { offset: true } // spacing/margin between bars
                }
            }
        }
    });

    // Task Completion Chart (Doughnut)
    const taskCtx = document.getElementById('taskChart').getContext('2d');
    const taskChart = new Chart(taskCtx, {
        type: 'doughnut',
        data: {
            labels: ['SickLeave', 'CasualLeave', 'Emergency Leave'],
            datasets: [{
                data: [5, 2, 3],
                backgroundColor: [
                    'rgba(67, 97, 238, 0.7)',
                    'rgba(76, 201, 240, 0.7)',
                    'rgba(247, 37, 133, 0.7)'
                ],
                borderColor: [
                    'rgba(67, 97, 238, 1)',
                    'rgba(76, 201, 240, 1)',
                    'rgba(247, 37, 133, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    const timerEl = document.getElementById('workDuration');
    if (!timerEl) {
      console.log('Timer element not found.');
      return;
    }

    // Read data attributes (already escaped from Django)
    const checkInRaw = timerEl.dataset.checkin || '';
    const checkedOutRaw = timerEl.dataset.checkedout || 'false';

    console.log('checkInRaw:', checkInRaw, 'checkedOutRaw:', checkedOutRaw);

    // Only run if checkin exists and not checked out
    if (!checkInRaw || checkedOutRaw === 'true') {
      console.log('No active timer: either no check-in or already checked out.');
      return;
    }

    // Convert 'YYYY-MM-DD HH:MM:SS' -> JS Date safely (replace '-' with '/')
    // Replace possible timezone differences â€” treat as local time
    const checkInIsoLike = checkInRaw.replace(/-/g, '/'); // "2025/11/27 09:30:00"
    const checkInDate = new Date(checkInIsoLike);

    if (isNaN(checkInDate.getTime())) {
      console.warn('Parsed check-in is invalid date:', checkInDate, checkInRaw);
      // try fallback: use Date.parse on ISO if available
      const fallback = Date.parse(checkInRaw);
      if (!isNaN(fallback)) {
        checkInDate = new Date(fallback);
      } else {
        return;
      }
    }

    // Make badge visible
    timerEl.classList.remove('d-none');

    // Update function
    let timerInterval = null;
    function updateElapsed() {
      const now = new Date();
      let diff = now - checkInDate; // milliseconds

      if (diff < 0) diff = 0;

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      const hh = hours < 10 ? '0' + hours : '' + hours;
      const mm = minutes < 10 ? '0' + minutes : '' + minutes;
      const ss = seconds < 10 ? '0' + seconds : '' + seconds;

      timerEl.textContent = `${hh}:${mm}:${ss}`;
    }

    // Start immediately and then every second
    updateElapsed();
    timerInterval = setInterval(updateElapsed, 1000);

    // Optional: stop timer automatically if the server later shows checkout (polling)
    // â€” If you don't need this, comment it out.
    const pollForCheckout = true;
    if (pollForCheckout) {
      const attendanceTopInfo = document.getElementById('attendanceTopInfo');
      setInterval(() => {
        // If template is re-rendered via AJAX later, dataset may change.
        const checkedOutNow = timerEl.dataset.checkedout || 'false';
        if (checkedOutNow === 'true') {
          clearInterval(timerInterval);
          timerEl.classList.add('d-none');
          console.log('Timer stopped because checked out detected.');
        }
      }, 3000); // every 3 seconds
    }

  } catch (err) {
    console.error('Timer script error:', err);
  }
});
</script>


{% endblock %}